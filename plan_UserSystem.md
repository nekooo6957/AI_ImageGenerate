# Nano Banana Pro - ç”¨æˆ·ç³»ç»Ÿä¸ç§¯åˆ†ç³»ç»Ÿå®æ–½è®¡åˆ’

## ä¸€ã€éœ€æ±‚æ¦‚è¿°

### 1.1 ä¸šåŠ¡ç›®æ ‡

ç”¨æˆ·å¸Œæœ›å»ºç«‹ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·ç³»ç»Ÿï¼Œå®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **ç»Ÿä¸€ç”¨æˆ·è®¤è¯**ï¼šç™»å½•è´¦å·åï¼Œåœ¨ä¸»å¹³å°å’Œçµæ„Ÿç¤¾åŒºä½¿ç”¨åŒä¸€èº«ä»½
2. **æ•°æ®åŒæ­¥**ï¼šæŸ¥çœ‹ç”Ÿå›¾å†å²è®°å½•ã€é¡¹ç›®ç®¡ç†å†…å®¹
3. **ç§¯åˆ†ç®¡ç†**ï¼šæ˜¾ç¤ºå½“å‰ç§¯åˆ†ä½™é¢ï¼Œæ ¹æ®ç”Ÿå›¾æ¶ˆè€—è‡ªåŠ¨æ‰£é™¤
4. **è·¨å¹³å°ä½“éªŒ**ï¼šåœ¨çµæ„Ÿç¤¾åŒºä»¥è‡ªå·±çš„ ID ä¸Šä¼ å†…å®¹

### 1.2 æŠ€æœ¯èƒŒæ™¯

**ç°æœ‰æ¶æ„åˆ†æï¼š**
- çº¯å‰ç«¯å•æ–‡ä»¶åº”ç”¨ï¼Œæ— åç«¯æœåŠ¡å™¨
- ç”¨æˆ·è®¤è¯ï¼šåŸºäºæœ¬åœ° SHA256 å¯†ç åŠ å¯†ï¼Œæ•°æ®å­˜å‚¨åœ¨æµè§ˆå™¨
- æ•°æ®å­˜å‚¨ï¼šIndexedDB + localStorageï¼ˆæ— æ³•è·¨è®¾å¤‡åŒæ­¥ï¼‰
- å›¾åƒç”Ÿæˆï¼šç›´æ¥è°ƒç”¨ APIMart API

**APIMart API æˆæœ¬ï¼š**
| åˆ†è¾¨ç‡ | æˆæœ¬ | å»ºè®®ç§¯åˆ†å€¼ |
|--------|------|-----------|
| 1K | $0.05 | 5 ç§¯åˆ† |
| 2K | $0.05 | 5 ç§¯åˆ† |
| 4K | $0.10 | 10 ç§¯åˆ† |

**æ±‡ç‡è®¾å®šï¼š1 ç§¯åˆ† = $0.01 â‰ˆ Â¥0.07**

### 1.3 ç”¨æˆ·æå‡ºçš„æ–¹æ¡ˆ

> ç”¨æˆ·æ€è·¯ï¼šæ ¹æ®å……å€¼æƒ…å†µï¼Œæä¾›ç”¨æˆ·æœ‰é™é¢çš„ API Keyã€‚ä¾‹å¦‚ç”¨æˆ·å……å€¼ $10ï¼Œå°±åœ¨ API Key è®¾ç½® $10 é™é¢ã€‚

**æ–¹æ¡ˆè¯„ä¼°ï¼š**

| æ–¹é¢ | å¯è¡Œæ€§ | è¯´æ˜ |
|------|--------|------|
| æŠ€æœ¯å®ç° | âœ… å¯è¡Œ | APIMart æ”¯æŒ API Key é™é¢è®¾ç½® |
| æ•°æ®å®‰å…¨ | âš ï¸ æœ‰é£é™© | API Key æš´éœ²åœ¨å‰ç«¯ï¼Œç”¨æˆ·å¯èƒ½æ»¥ç”¨ |
| è·¨è®¾å¤‡åŒæ­¥ | âŒ ä¸å¯è¡Œ | API Key å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ |
| ç§¯åˆ†ç®¡ç† | âš ï¸ å¤æ‚ | éœ€è¦æ‰‹åŠ¨åœ¨ APIMart åå°ç®¡ç† |
| ç”¨æˆ·ä½“éªŒ | âš ï¸ ä¸€èˆ¬ | éœ€è¦ç”¨æˆ·è‡ªå·±è¾“å…¥å’Œç®¡ç† API Key |

**ç»“è®ºï¼š** ç”¨æˆ·æå‡ºçš„æ–¹æ¡ˆå¯ä»¥ä½œä¸ºä¸´æ—¶æ–¹æ¡ˆï¼Œä½†ä¸é€‚åˆä½œä¸ºé•¿æœŸè§£å†³æ–¹æ¡ˆã€‚

---

## äºŒã€æ¨èæŠ€æœ¯æ–¹æ¡ˆ

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯åº”ç”¨                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  ä¸»å¹³å° HTML â”‚  â”‚ çµæ„Ÿç¤¾åŒº HTML â”‚  â”‚  ç”¨æˆ·ä¸­å¿ƒ    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†• HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Supabase BaaS                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ç”¨æˆ·è®¤è¯ç³»ç»Ÿ â”‚  â”‚  PostgreSQL  â”‚  â”‚ Edge Functionsâ”‚     â”‚
â”‚  â”‚  (Auth)      â”‚  â”‚   Database   â”‚  â”‚  (API ä»£ç†)  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç¬¬ä¸‰æ–¹ API æœåŠ¡                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ APIMart API  â”‚  â”‚ æ”¯ä»˜æ¥å£ï¼ˆæœªæ¥ï¼‰â”‚                       â”‚
â”‚  â”‚ (å›¾åƒç”Ÿæˆ)   â”‚  â”‚  (è™çš®æ¤’ç­‰)  â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ä¸ºä»€ä¹ˆé€‰æ‹© Supabaseï¼Ÿ

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **å¿«é€Ÿä¸Šçº¿** | æ— éœ€è‡ªå·±æ­å»ºæœåŠ¡å™¨ï¼Œ1-2å¤©å³å¯å®Œæˆé›†æˆ |
| **å…è´¹é¢åº¦** | 500MB æ•°æ®åº“ + 1GB æ–‡ä»¶å­˜å‚¨ + 50k MAU |
| **ç”¨æˆ·è®¤è¯** | å¼€ç®±å³ç”¨çš„ç”¨æˆ·ç³»ç»Ÿï¼ˆé‚®ç®±/å¯†ç ã€OAuthï¼‰ |
| **æ•°æ®å®‰å…¨** | Row Level Security (RLS) ä¿æŠ¤æ•°æ®å®‰å…¨ |
| **API ä»£ç†** | Edge Functions å¯ä»¥ä»£ç† APIMart è°ƒç”¨ï¼Œéšè— API Key |
| **å›½å†…å‹å¥½** | æ”¯æŒå›½å†…è®¿é—®ï¼Œæ”¯ä»˜å¯æ¥å…¥è™çš®æ¤’/ PayJS |

### 2.3 æ ¸å¿ƒåŠŸèƒ½å®ç°

#### A. ç”¨æˆ·è®¤è¯ç³»ç»Ÿ

```javascript
// ä½¿ç”¨ Supabase Auth
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// æ³¨å†Œ
const { data, error } = await supabase.auth.signUp({
  email: 'user@example.com',
  password: 'password123'
})

// ç™»å½•
const { data, error } = await supabase.auth.signInWithPassword({
  email: 'user@example.com',
  password: 'password123'
})

// è·å–å½“å‰ç”¨æˆ·
const { data: { user } } = await supabase.auth.getUser()
```

#### B. ç§¯åˆ†ç³»ç»Ÿè®¾è®¡

**æ•°æ®åº“è¡¨ç»“æ„ï¼š**

```sql
-- ç”¨æˆ·ç§¯åˆ†è¡¨
CREATE TABLE user_credits (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users NOT NULL,
  balance INTEGER DEFAULT 0,           -- å½“å‰ç§¯åˆ†ä½™é¢
  total_recharged INTEGER DEFAULT 0,   -- ç´¯è®¡å……å€¼ç§¯åˆ†
  total_consumed INTEGER DEFAULT 0,    -- ç´¯è®¡æ¶ˆè€—ç§¯åˆ†
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ç§¯åˆ†äº¤æ˜“è®°å½•
CREATE TABLE credit_transactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users NOT NULL,
  type TEXT NOT NULL,                  -- 'recharge' | 'consume' | 'refund'
  amount INTEGER NOT NULL,             -- ç§¯åˆ†å˜åŒ–ï¼ˆæ­£æ•°=å¢åŠ ï¼Œè´Ÿæ•°=å‡å°‘ï¼‰
  balance_after INTEGER NOT NULL,      -- äº¤æ˜“åä½™é¢
  description TEXT,                    -- æè¿°
  metadata JSONB,                      -- é¢å¤–ä¿¡æ¯ {resolution, count, projectId}
  status TEXT DEFAULT 'completed',     -- 'completed' | 'failed' | 'pending'
  created_at TIMESTAMP DEFAULT NOW()
);

-- ç”Ÿæˆæ—¥å¿—
CREATE TABLE generation_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users NOT NULL,
  project_id TEXT,
  prompt TEXT,
  config JSONB,                        -- {ratio, resolution, n}
  cost INTEGER,                        -- æ¶ˆè€—ç§¯åˆ†
  apimart_task_id TEXT,
  status TEXT,                         -- 'pending' | 'succeeded' | 'failed'
  result_url TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### C. API ä»£ç†ï¼ˆéšè— APIMart Keyï¼‰

**Edge Function ä»£ç ï¼š**

```typescript
// supabase/functions/generate-image/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'

const APIMART_KEY = Deno.env.get('APIMART_KEY') // å­˜å‚¨åœ¨æœåŠ¡ç«¯

serve(async (req) => {
  const { prompt, size, resolution, n } = await req.json()

  // è°ƒç”¨ APIMart API
  const response = await fetch('https://api.apimart.ai/v1/images/generations', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${APIMART_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      model: 'gemini-3-pro-image-preview',
      prompt,
      size,
      n,
      resolution
    })
  })

  const data = await response.json()
  return new Response(JSON.stringify(data), {
    headers: { 'Content-Type': 'application/json' }
  })
})
```

**ä¼˜åŠ¿ï¼š**
- âœ… API Key ä¸æš´éœ²åœ¨å‰ç«¯
- âœ… å¯ä»¥åœ¨æœåŠ¡ç«¯éªŒè¯ç”¨æˆ·ç§¯åˆ†
- âœ… å¯ä»¥ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç”¨æˆ·çš„ API è°ƒç”¨
- âœ… å¯ä»¥è®°å½•è¯¦ç»†çš„ä½¿ç”¨æ—¥å¿—

---

## ä¸‰ã€ç§¯åˆ†ç³»ç»Ÿè®¾è®¡

### 3.1 å®šä»·ç­–ç•¥

#### A. ç§¯åˆ†ä¸æˆæœ¬å¯¹åº”å…³ç³»

| ç”Ÿæˆç±»å‹ | APIMart æˆæœ¬ | æ¶ˆè€—ç§¯åˆ† | ç”¨æˆ·æˆæœ¬ï¼ˆæŒ‰æ±‡ç‡ï¼‰ |
|---------|-------------|---------|-------------------|
| 1K å•å¼  | $0.05 | 5 ç§¯åˆ† | Â¥0.36 |
| 2K å•å¼  | $0.05 | 5 ç§¯åˆ† | Â¥0.36 |
| 4K å•å¼  | $0.10 | 10 ç§¯åˆ† | Â¥0.72 |

**è¯´æ˜ï¼š**
- 1 ç§¯åˆ† = $0.01ï¼ˆAPIMart æˆæœ¬ï¼‰
- æ±‡ç‡ï¼š1 ç¾å…ƒ â‰ˆ 7.2 äººæ°‘å¸
- å¹³å°ä¸èµšå–å·®ä»·ï¼ˆæˆæœ¬å®šä»·ï¼‰

#### B. å……å€¼å¥—é¤

| å……å€¼é‡‘é¢ | è·å¾—ç§¯åˆ† | æ±‡ç‡ | å¤‡æ³¨ |
|---------|---------|------|------|
| Â¥10 | 139 ç§¯åˆ† | Â¥0.072/ç§¯åˆ† | ä½“éªŒåŒ… |
| Â¥50 | 694 ç§¯åˆ† | Â¥0.072/ç§¯åˆ† | å¸¸ç”¨åŒ… |
| Â¥100 | 1389 ç§¯åˆ† | Â¥0.072/ç§¯åˆ† | å……å€¼åŒ… |
| Â¥500 | 6944 ç§¯åˆ† | Â¥0.072/ç§¯åˆ† | å¤§å®¹é‡åŒ… |

**å¯ç”Ÿæˆå›¾ç‰‡æ•°é‡ï¼ˆä»¥ 2K ä¸ºä¾‹ï¼‰ï¼š**
- Â¥10 â†’ 139 ç§¯åˆ† â†’ çº¦ 27 å¼ 
- Â¥50 â†’ 694 ç§¯åˆ† â†’ çº¦ 138 å¼ 
- Â¥100 â†’ 1389 ç§¯åˆ† â†’ çº¦ 277 å¼ 
- Â¥500 â†’ 6944 ç§¯åˆ† â†’ çº¦ 1388 å¼ 

### 3.2 ç§¯åˆ†æ“ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç§¯åˆ†ç³»ç»Ÿæµç¨‹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€å……å€¼æµç¨‹ã€‘
ç”¨æˆ·é€‰æ‹©å¥—é¤ â†’ åˆ›å»ºå……å€¼è®¢å• â†’ è·³è½¬æ”¯ä»˜ â†’ æ”¯ä»˜å›è°ƒ â†’ å¢åŠ ç§¯åˆ†
                                                           â†“
                                                    è®°å½•äº¤æ˜“å†å²

ã€ç”Ÿå›¾æµç¨‹ã€‘
ç”¨æˆ·ç‚¹å‡»ç”Ÿæˆ â†’ æ£€æŸ¥ç§¯åˆ†ä½™é¢ â†’ æ‰£é™¤ç§¯åˆ† â†’ è°ƒç”¨ API â†’ ç”Ÿæˆå®Œæˆ
                      â†“                              â†“
                 ç§¯åˆ†ä¸è¶³æç¤º                  å¤±è´¥åˆ™é€€è¿˜ç§¯åˆ†

ã€æŸ¥è¯¢æµç¨‹ã€‘
ç”¨æˆ·ç™»å½• â†’ è¯»å–ç§¯åˆ†ä½™é¢ â†’ æ˜¾ç¤ºåœ¨ç•Œé¢ â†’ ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… â†’ äº¤æ˜“å†å²
```

### 3.3 ä¸´æ—¶æ–¹æ¡ˆï¼ˆä¸ç”¨æ”¯ä»˜ç³»ç»Ÿï¼‰

å¦‚æœæš‚æ—¶ä¸æƒ³æ¥å…¥æ”¯ä»˜ç³»ç»Ÿï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹æ–¹å¼ï¼š

#### æ–¹æ¡ˆ 1ï¼šç®¡ç†å‘˜æ‰‹åŠ¨å……å€¼

```javascript
// ç®¡ç†å‘˜åœ¨ Supabase Dashboard ç›´æ¥æ“ä½œ
// æˆ–è€…åˆ›å»ºä¸€ä¸ªç®€å•çš„ç®¡ç†ç•Œé¢
async function adminAddCredits(userId, amount, reason) {
  const { data, error } = await supabase
    .from('user_credits')
    .update({
      balance: supabase.raw(`balance + ${amount}`),
      total_recharged: supabase.raw(`total_recharged + ${amount}`)
    })
    .eq('user_id', userId)

  // è®°å½•äº¤æ˜“
  await supabase.from('credit_transactions').insert({
    user_id: userId,
    type: 'recharge',
    amount: amount,
    balance_after: newBalance,
    description: reason
  })
}
```

**ä½¿ç”¨åœºæ™¯ï¼š**
- ç”¨æˆ·é€šè¿‡å¾®ä¿¡/æ”¯ä»˜å®è½¬è´¦ç»™ç®¡ç†å‘˜
- ç®¡ç†å‘˜æ‰‹åŠ¨ä¸ºç”¨æˆ·æ·»åŠ ç§¯åˆ†
- é€‚åˆå†…æµ‹é˜¶æ®µæˆ–å°è§„æ¨¡ä½¿ç”¨

#### æ–¹æ¡ˆ 2ï¼šé‚€è¯·æ³¨å†Œå¥–åŠ±

```javascript
// æ–°ç”¨æˆ·æ³¨å†Œèµ é€ç§¯åˆ†
async function onUserSignUp(userId) {
  await supabase.from('user_credits').insert({
    user_id: userId,
    balance: 20,  // æ–°ç”¨æˆ·èµ é€ 20 ç§¯åˆ†
    total_recharged: 20
  })
}

// é‚€è¯·å¥½å‹å¥–åŠ±
async function onInviteSuccess(inviterId) {
  await supabase.rpc('add_credits', {
    user_id: inviterId,
    amount: 50  // é‚€è¯·æˆåŠŸå¥–åŠ± 50 ç§¯åˆ†
  })
}
```

---

## å››ã€æ•°æ®åº“è®¾è®¡ï¼ˆSupabase PostgreSQLï¼‰

### 4.1 å®Œæ•´è¡¨ç»“æ„

```sql
-- å¯ç”¨ UUID æ‰©å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ====================
-- ç”¨æˆ·ç§¯åˆ†è¡¨
-- ====================
CREATE TABLE user_credits (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users NOT NULL UNIQUE,
  balance INTEGER DEFAULT 0 CHECK (balance >= 0),
  total_recharged INTEGER DEFAULT 0,
  total_consumed INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ====================
-- ç§¯åˆ†äº¤æ˜“è®°å½•
-- ====================
CREATE TABLE credit_transactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('recharge', 'consume', 'refund', 'bonus')),
  amount INTEGER NOT NULL,
  balance_after INTEGER NOT NULL,
  description TEXT,
  metadata JSONB DEFAULT '{}',
  status TEXT DEFAULT 'completed' CHECK (status IN ('completed', 'failed', 'pending')),
  created_at TIMESTAMP DEFAULT NOW()
);

-- ====================
-- ç”Ÿæˆæ—¥å¿—
-- ====================
CREATE TABLE generation_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users NOT NULL,
  project_id TEXT,
  prompt TEXT NOT NULL,
  config JSONB NOT NULL,  -- {ratio, resolution, n, tags}
  cost INTEGER NOT NULL,
  apimart_task_id TEXT,
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'succeeded', 'failed')),
  result_urls TEXT[],
  created_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP
);

-- ====================
-- é¡¹ç›®ç®¡ç†
-- ====================
CREATE TABLE user_projects (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users NOT NULL,
  name TEXT NOT NULL,
  is_default BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ====================
-- çµæ„Ÿç¤¾åŒºå†…å®¹
-- ====================
CREATE TABLE community_posts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users NOT NULL,
  title TEXT,
  description TEXT,
  prompt TEXT,
  image_url TEXT NOT NULL,
  tags TEXT[],
  likes_count INTEGER DEFAULT 0,
  views_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ====================
-- ç´¢å¼•
-- ====================
CREATE INDEX idx_transactions_user ON credit_transactions(user_id, created_at DESC);
CREATE INDEX idx_generations_user ON generation_logs(user_id, created_at DESC);
CREATE INDEX idx_projects_user ON user_projects(user_id, name);
CREATE INDEX idx_community_user ON community_posts(user_id, created_at DESC);
CREATE INDEX idx_community_tags ON community_posts USING GIN(tags);

-- ====================
-- è§¦å‘å™¨ï¼šè‡ªåŠ¨æ›´æ–° updated_at
-- ====================
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_user_credits_updated_at BEFORE UPDATE ON user_credits
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_user_projects_updated_at BEFORE UPDATE ON user_projects
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ====================
-- Row Level Security (RLS)
-- ====================

-- å¯ç”¨ RLS
ALTER TABLE user_credits ENABLE ROW LEVEL SECURITY;
ALTER TABLE credit_transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE generation_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE community_posts ENABLE ROW LEVEL SECURITY;

-- ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
CREATE POLICY "Users can view own credits" ON user_credits
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can view own transactions" ON credit_transactions
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can view own generations" ON generation_logs
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can manage own projects" ON user_projects
    FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Anyone can view community posts" ON community_posts
    FOR SELECT USING (true);

CREATE POLICY "Users can create own posts" ON community_posts
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own posts" ON community_posts
    FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own posts" ON community_posts
    FOR DELETE USING (auth.uid() = user_id);
```

### 4.2 æ•°æ®åº“å‡½æ•°

```sql
-- ====================
-- ç§¯åˆ†æ“ä½œå‡½æ•°
-- ====================

-- æ‰£é™¤ç§¯åˆ†
CREATE OR REPLACE FUNCTION deduct_credits(
  p_user_id UUID,
  p_amount INTEGER,
  p_description TEXT,
  p_metadata JSONB DEFAULT '{}'
) RETURNS TABLE(success BOOLEAN, new_balance INTEGER, transaction_id UUID) AS $$
DECLARE
  v_current_balance INTEGER;
  v_new_balance INTEGER;
  v_transaction_id UUID;
BEGIN
  -- è·å–å½“å‰ä½™é¢
  SELECT balance INTO v_current_balance
  FROM user_credits
  WHERE user_id = p_user_id;

  -- æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
  IF v_current_balance < p_amount THEN
    RETURN QUERY SELECT false, v_current_balance, NULL::UUID;
    RETURN;
  END IF;

  -- æ‰£é™¤ç§¯åˆ†
  UPDATE user_credits
  SET
    balance = balance - p_amount,
    total_consumed = total_consumed + p_amount
  WHERE user_id = p_user_id
  RETURNING balance INTO v_new_balance;

  -- è®°å½•äº¤æ˜“
  INSERT INTO credit_transactions (user_id, type, amount, balance_after, description, metadata)
  VALUES (p_user_id, 'consume', -p_amount, v_new_balance, p_description, p_metadata)
  RETURNING id INTO v_transaction_id;

  RETURN QUERY SELECT true, v_new_balance, v_transaction_id;
END;
$$ LANGUAGE plpgsql;

-- å¢åŠ ç§¯åˆ†
CREATE OR REPLACE FUNCTION add_credits(
  p_user_id UUID,
  p_amount INTEGER,
  p_description TEXT,
  p_metadata JSONB DEFAULT '{}',
  p_type TEXT DEFAULT 'recharge'
) RETURNS TABLE(new_balance INTEGER, transaction_id UUID) AS $$
DECLARE
  v_new_balance INTEGER;
  v_transaction_id UUID;
BEGIN
  -- å¢åŠ ç§¯åˆ†
  INSERT INTO user_credits (user_id, balance, total_recharged)
  VALUES (p_user_id, p_amount, p_amount)
  ON CONFLICT (user_id) DO UPDATE
  SET
    balance = user_credits.balance + p_amount,
    total_recharged = user_credits.total_recharged +
      CASE WHEN p_type = 'recharge' THEN p_amount ELSE 0 END
  RETURNING balance INTO v_new_balance;

  -- è®°å½•äº¤æ˜“
  INSERT INTO credit_transactions (user_id, type, amount, balance_after, description, metadata)
  VALUES (p_user_id, p_type, p_amount, v_new_balance, p_description, p_metadata)
  RETURNING id INTO v_transaction_id;

  RETURN QUERY SELECT v_new_balance, v_transaction_id;
END;
$$ LANGUAGE plpgsql;

-- é€€è¿˜ç§¯åˆ†ï¼ˆç”Ÿæˆå¤±è´¥æ—¶ï¼‰
CREATE OR REPLACE FUNCTION refund_credits(
  p_transaction_id UUID
) RETURNS TABLE(success BOOLEAN, new_balance INTEGER) AS $$
DECLARE
  v_user_id UUID;
  v_amount INTEGER;
  v_current_balance INTEGER;
BEGIN
  -- è·å–åŸäº¤æ˜“è®°å½•
  SELECT user_id, ABS(amount) INTO v_user_id, v_amount
  FROM credit_transactions
  WHERE id = p_transaction_id AND type = 'consume';

  IF NOT FOUND THEN
    RETURN QUERY SELECT false, NULL::INTEGER;
    RETURN;
  END IF;

  -- å¢åŠ ç§¯åˆ†
  UPDATE user_credits
  SET
    balance = balance + v_amount,
    total_consumed = total_consumed - v_amount
  WHERE user_id = v_user_id
  RETURNING balance INTO v_current_balance;

  -- è®°å½•é€€æ¬¾äº¤æ˜“
  INSERT INTO credit_transactions (user_id, type, amount, balance_after, description)
  VALUES (v_user_id, 'refund', v_amount, v_current_balance, 'ç”Ÿæˆå¤±è´¥é€€è¿˜');

  RETURN QUERY SELECT true, v_current_balance;
END;
$$ LANGUAGE plpgsql;
```

---

## äº”ã€Edge Functions å®ç°

### 5.1 å›¾åƒç”Ÿæˆï¼ˆå¸¦ç§¯åˆ†éªŒè¯ï¼‰

```typescript
// supabase/functions/generate-image/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const APIMART_KEY = Deno.env.get('APIMART_KEY')!
const SUPABASE_URL = Deno.env.get('SUPABASE_URL')!
const SUPABASE_SERVICE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!

// ç§¯åˆ†æ¶ˆè€—è§„åˆ™
const COST_RULES = {
  '1K': 5,
  '2K': 5,
  '4K': 10
}

serve(async (req) => {
  try {
    // éªŒè¯ç”¨æˆ·èº«ä»½
    const authHeader = req.headers.get('Authorization')!
    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY, {
      global: { headers: { Authorization: authHeader } }
    })

    const { data: { user }, error: authError } = await supabase.auth.getUser()
    if (authError || !user) {
      return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401 })
    }

    // è§£æè¯·æ±‚å‚æ•°
    const { prompt, size, resolution, n = 1, project_id } = await req.json()

    // è®¡ç®—æ¶ˆè€—ç§¯åˆ†
    const cost = COST_RULES[resolution as keyof typeof COST_RULES] * n

    // éªŒè¯å¹¶æ‰£é™¤ç§¯åˆ†
    const { data: creditData, error: creditError } = await supabase
      .rpc('deduct_credits', {
        p_user_id: user.id,
        p_amount: cost,
        p_description: `ç”Ÿæˆ ${resolution} å›¾ç‰‡ Ã— ${n}å¼ `,
        p_metadata: { resolution, count: n, project_id }
      })

    if (creditError || !creditData[0].success) {
      return new Response(
        JSON.stringify({
          error: 'Insufficient credits',
          required: cost,
          balance: creditData?.[0]?.new_balance || 0
        }),
        { status: 400 }
      )
    }

    const transactionId = creditData[0].transaction_id
    const newBalance = creditData[0].new_balance

    // è°ƒç”¨ APIMart API
    const apimartResponse = await fetch('https://api.apimart.ai/v1/images/generations', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${APIMART_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'gemini-3-pro-image-preview',
        prompt,
        size,
        n,
        resolution,
        image_urls: []
      })
    })

    if (!apimartResponse.ok) {
      // API è°ƒç”¨å¤±è´¥ï¼Œé€€è¿˜ç§¯åˆ†
      await supabase.rpc('refund_credits', { p_transaction_id: transactionId })
      return new Response(
        JSON.stringify({ error: 'API request failed', credits_refunded: cost }),
        { status: 500 }
      )
    }

    const apimartData = await apimartResponse.json()

    // è®°å½•ç”Ÿæˆæ—¥å¿—
    const { data: logData } = await supabase
      .from('generation_logs')
      .insert({
        user_id: user.id,
        project_id,
        prompt,
        config: { size, resolution, n },
        cost,
        apimart_task_id: apimartData.task_id,
        status: 'pending'
      })
      .select()
      .single()

    return new Response(JSON.stringify({
      task_id: apimartData.task_id,
      generation_id: logData.id,
      transaction_id: transactionId,
      new_balance: newBalance,
      cost: cost
    }), {
      headers: { 'Content-Type': 'application/json' }
    })

  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), { status: 500 })
  }
})
```

### 5.2 æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ï¼ˆå¸¦è‡ªåŠ¨é€€æ¬¾ï¼‰

```typescript
// supabase/functions/check-task/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const APIMART_KEY = Deno.env.get('APIMART_KEY')!
const SUPABASE_URL = Deno.env.get('SUPABASE_URL')!
const SUPABASE_SERVICE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!

serve(async (req) => {
  try {
    const { task_id, generation_id, transaction_id } = await req.json()

    // è°ƒç”¨ APIMart API æŸ¥è¯¢çŠ¶æ€
    const response = await fetch(`https://api.apimart.ai/v1/tasks/${task_id}?language=zh`, {
      headers: { 'Authorization': `Bearer ${APIMART_KEY}` }
    })

    const data = await response.json()
    const status = data.task_status // 'succeeded' | 'failed' | 'processing'

    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY)

    if (status === 'succeeded') {
      // æ›´æ–°ç”Ÿæˆæ—¥å¿—
      await supabase
        .from('generation_logs')
        .update({
          status: 'succeeded',
          result_urls: data.result_urls,
          completed_at: new Date().toISOString()
        })
        .eq('id', generation_id)

      return new Response(JSON.stringify({
        status: 'succeeded',
        urls: data.result_urls
      }))
    } else if (status === 'failed') {
      // ç”Ÿæˆå¤±è´¥ï¼Œé€€è¿˜ç§¯åˆ†
      const { data: refundData } = await supabase
        .rpc('refund_credits', { p_transaction_id: transaction_id })

      // æ›´æ–°ç”Ÿæˆæ—¥å¿—
      await supabase
        .from('generation_logs')
        .update({ status: 'failed', completed_at: new Date().toISOString() })
        .eq('id', generation_id)

      return new Response(JSON.stringify({
        status: 'failed',
        error: data.error?.message || 'Generation failed',
        credits_refunded: refundData?.[0]?.success
      }))
    }

    return new Response(JSON.stringify({ status: 'processing' }))

  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), { status: 500 })
  }
})
```

### 5.3 è·å–ç”¨æˆ·ç§¯åˆ†ä¿¡æ¯

```typescript
// supabase/functions/get-user-credits/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const SUPABASE_URL = Deno.env.get('SUPABASE_URL')!
const SUPABASE_SERVICE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!

serve(async (req) => {
  try {
    const authHeader = req.headers.get('Authorization')!
    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY, {
      global: { headers: { Authorization: authHeader } }
    })

    const { data: { user }, error: authError } = await supabase.auth.getUser()
    if (authError || !user) {
      return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401 })
    }

    // è·å–ç§¯åˆ†ä½™é¢
    const { data: credits } = await supabase
      .from('user_credits')
      .select('*')
      .eq('user_id', user.id)
      .single()

    // è·å–æœ€è¿‘äº¤æ˜“è®°å½•
    const { data: transactions } = await supabase
      .from('credit_transactions')
      .select('*')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false })
      .limit(20)

    return new Response(JSON.stringify({
      credits: credits || { balance: 0, total_recharged: 0, total_consumed: 0 },
      transactions: transactions || []
    }), {
      headers: { 'Content-Type': 'application/json' }
    })

  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), { status: 500 })
  }
})
```

---

## å…­ã€å‰ç«¯é›†æˆæ–¹æ¡ˆ

### 6.1 ç”¨æˆ·ç•Œé¢æ”¹é€ 

#### A. ç™»å½•/æ³¨å†Œç•Œé¢

```html
<!-- æ›¿æ¢åŸæœ‰çš„æœ¬åœ°è®¤è¯ä¸º Supabase Auth -->
<div id="authModal" class="fixed inset-0 z-[100] flex" style="display: none;">
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8">
      <h2 class="text-2xl font-bold mb-6 text-center">ç™»å½• Nano Banana Pro</h2>

      <form id="authForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">é‚®ç®±</label>
          <input type="email" id="authEmail" required
                 class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">å¯†ç </label>
          <input type="password" id="authPassword" required
                 class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500">
        </div>
        <button type="submit" class="w-full bg-black text-white py-3 rounded-xl font-medium hover:bg-gray-800">
          ç™»å½•
        </button>
      </form>

      <div class="mt-4 text-center">
        <span class="text-gray-600">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
        <button id="switchToSignUp" class="text-blue-600 font-medium">ç«‹å³æ³¨å†Œ</button>
      </div>
    </div>
  </div>
</div>
```

#### B. ç§¯åˆ†æ˜¾ç¤ºç»„ä»¶

```html
<!-- åœ¨ä¸»ç•Œé¢é¡¶éƒ¨æ·»åŠ ç§¯åˆ†æ˜¾ç¤º -->
<div class="flex items-center gap-4 px-6 py-3 bg-gray-50 rounded-xl border border-gray-100">
  <div class="flex items-center gap-2">
    <i class="fas fa-coins text-yellow-500"></i>
    <span class="text-sm text-gray-600">ç§¯åˆ†ä½™é¢</span>
  </div>
  <span id="creditsBalance" class="font-bold text-lg">--</span>
  <button onclick="openRechargeModal()" class="ml-auto text-sm bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
    å……å€¼
  </button>
</div>

<!-- æ¶ˆè€—æç¤º -->
<div id="costPreview" class="flex items-center justify-between px-4 py-2 bg-blue-50 rounded-lg text-sm">
  <span>ç”Ÿæˆé…ç½®ï¼š2K Ã— 4å¼ </span>
  <span>é¢„è®¡æ¶ˆè€—ï¼š<strong class="text-blue-600">20 ç§¯åˆ†</strong> (çº¦ Â¥1.44)</span>
</div>
```

### 6.2 JavaScript é›†æˆä»£ç 

```javascript
// ========== å¼•å…¥ Supabase SDK ==========
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ========== Supabase é…ç½® ==========
const SUPABASE_URL = 'YOUR_SUPABASE_URL'
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// ========== ç”¨æˆ·è®¤è¯ ==========
async function handleSignUp() {
  const email = document.getElementById('authEmail').value
  const password = document.getElementById('authPassword').value

  const { data, error } = await supabase.auth.signUp({
    email,
    password
  })

  if (error) {
    alert('æ³¨å†Œå¤±è´¥ï¼š' + error.message)
    return
  }

  // åˆ›å»ºç”¨æˆ·ç§¯åˆ†è®°å½•
  await fetch('/functions/create-user-credits', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${data.session.access_token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ user_id: data.user.id })
  })

  alert('æ³¨å†ŒæˆåŠŸï¼å·²èµ é€ 20 ç§¯åˆ†')
  closeAuthModal()
  await loadUserData()
}

async function handleLogin() {
  const email = document.getElementById('authEmail').value
  const password = document.getElementById('authPassword').value

  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password
  })

  if (error) {
    alert('ç™»å½•å¤±è´¥ï¼š' + error.message)
    return
  }

  closeAuthModal()
  await loadUserData()
}

async function handleLogout() {
  await supabase.auth.signOut()
  location.reload()
}

// ========== åŠ è½½ç”¨æˆ·æ•°æ® ==========
async function loadUserData() {
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return

  // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
  document.getElementById('userEmail').textContent = user.email

  // åŠ è½½ç§¯åˆ†ä½™é¢
  await loadUserCredits()

  // åŠ è½½é¡¹ç›®åˆ—è¡¨
  await loadProjectsFromServer()

  // åŠ è½½ç”Ÿæˆå†å²
  await loadGenerationsFromServer()
}

// ========== ç§¯åˆ†ç®¡ç† ==========
async function loadUserCredits() {
  const { data, error } = await supabase
    .from('user_credits')
    .select('*')
    .single()

  if (data) {
    document.getElementById('creditsBalance').textContent = data.balance
  }
}

// ========== ä¿®æ”¹ç”Ÿæˆæµç¨‹ ==========
async function executeSynthesis() {
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    alert('è¯·å…ˆç™»å½•')
    openAuthModal()
    return
  }

  const cost = calculateCost(platformState.res, platformState.n)

  // è°ƒç”¨ Edge Function ç”Ÿæˆå›¾ç‰‡
  const { data, error } = await supabase.functions.invoke('generate-image', {
    body: {
      prompt: userPrompt,
      size: platformState.ratio,
      resolution: platformState.res,
      n: platformState.n,
      project_id: platformState.currentProject
    }
  })

  if (error) {
    if (error.message.includes('Insufficient credits')) {
      alert(`ç§¯åˆ†ä¸è¶³ï¼éœ€è¦ ${error.required} ç§¯åˆ†ï¼Œå½“å‰ ${error.balance} ç§¯åˆ†`)
      openRechargeModal()
    } else {
      alert('ç”Ÿæˆå¤±è´¥ï¼š' + error.message)
    }
    return
  }

  // è½®è¯¢ä»»åŠ¡çŠ¶æ€
  pollTaskStatus(data.task_id, data.generation_id, data.transaction_id)
}

function calculateCost(resolution, count) {
  const costs = { '1K': 5, '2K': 5, '4K': 10 }
  return costs[resolution] * count
}

async function pollTaskStatus(taskId, generationId, transactionId) {
  const timer = setInterval(async () => {
    const { data } = await supabase.functions.invoke('check-task', {
      body: { task_id: taskId, generation_id: generationId, transaction_id: transactionId }
    })

    if (data.status === 'succeeded') {
      clearInterval(timer)
      displayResults(data.urls)
      await loadUserCredits() // åˆ·æ–°ç§¯åˆ†
    } else if (data.status === 'failed') {
      clearInterval(timer)
      alert('ç”Ÿæˆå¤±è´¥ï¼Œç§¯åˆ†å·²é€€è¿˜')
      await loadUserCredits() // åˆ·æ–°ç§¯åˆ†
    }
  }, 3000)
}
</script>
```

### 6.3 çµæ„Ÿç¤¾åŒºé›†æˆ

```javascript
// ========== çµæ„Ÿç¤¾åŒºç”¨æˆ·ç³»ç»Ÿ ==========

// æ£€æŸ¥ç™»å½•çŠ¶æ€
async function checkCommunityAuth() {
  const { data: { user } } = await supabase.auth.getUser()

  if (user) {
    // å·²ç™»å½•ï¼Œæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    document.getElementById('communityUserInfo').innerHTML = `
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold">
          ${user.email[0].toUpperCase()}
        </div>
        <div>
          <p class="font-medium">${user.email}</p>
          <p class="text-xs text-gray-500">ç‚¹å‡»ä¸Šä¼ ä½œå“</p>
        </div>
      </div>
    `
    document.getElementById('uploadBtn').disabled = false
  } else {
    // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æŒ‰é’®
    document.getElementById('communityUserInfo').innerHTML = `
      <button onclick="openAuthModal()" class="bg-black text-white px-6 py-2 rounded-xl">
        ç™»å½•åä¸Šä¼ ä½œå“
      </button>
    `
    document.getElementById('uploadBtn').disabled = true
  }
}

// ä¸Šä¼ ä½œå“åˆ°ç¤¾åŒº
async function uploadToCommunity(imageData, prompt, tags) {
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    alert('è¯·å…ˆç™»å½•')
    openAuthModal()
    return
  }

  // ä¸Šä¼ å›¾ç‰‡åˆ° Supabase Storage
  const fileName = `${user.id}/${Date.now()}.png`
  const { data: uploadData, error: uploadError } = await supabase.storage
    .from('community-images')
    .upload(fileName, decodeBase64Data(imageData), {
      contentType: 'image/png'
    })

  if (uploadError) {
    alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š' + uploadError.message)
    return
  }

  // è·å–å…¬å…± URL
  const { data: { publicUrl } } = supabase.storage
    .from('community-images')
    .getPublicUrl(fileName)

  // ä¿å­˜åˆ°æ•°æ®åº“
  const { error } = await supabase
    .from('community_posts')
    .insert({
      user_id: user.id,
      title: `æˆ‘çš„ä½œå“ ${new Date().toLocaleDateString()}`,
      description: '',
      prompt: prompt,
      image_url: publicUrl,
      tags: tags
    })

  if (error) {
    alert('å‘å¸ƒå¤±è´¥ï¼š' + error.message)
  } else {
    alert('å‘å¸ƒæˆåŠŸï¼')
    loadCommunityPosts() // åˆ·æ–°åˆ—è¡¨
  }
}

// åŠ è½½ç¤¾åŒºå†…å®¹
async function loadCommunityPosts() {
  const { data: posts } = await supabase
    .from('community_posts')
    .select('*, user_credits(user_id)')
    .order('created_at', { ascending: false })
    .limit(50)

  renderCommunityPosts(posts)
}
```

---

## ä¸ƒã€å®æ–½æ­¥éª¤

### Phase 1: Supabase åç«¯æ­å»ºï¼ˆç¬¬ 1 å‘¨ï¼‰

#### Day 1-2: é¡¹ç›®åˆå§‹åŒ–
- [ ] æ³¨å†Œ Supabase è´¦å·
- [ ] åˆ›å»ºæ–°é¡¹ç›®
- [ ] è·å– API å¯†é’¥ï¼ˆURL, anon key, service_role keyï¼‰
- [ ] å®‰è£… Supabase CLIï¼ˆå¯é€‰ï¼Œç”¨äºæœ¬åœ°å¼€å‘ï¼‰

#### Day 3-4: æ•°æ®åº“åˆ›å»º
- [ ] åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œæ•°æ®åº“ schema
- [ ] åˆ›å»ºæ‰€æœ‰è¡¨ï¼ˆuser_credits, credit_transactions, generation_logs ç­‰ï¼‰
- [ ] è®¾ç½® Row Level Security (RLS) ç­–ç•¥
- [ ] åˆ›å»ºæ•°æ®åº“å‡½æ•°ï¼ˆdeduct_credits, add_credits, refund_creditsï¼‰
- [ ] æµ‹è¯•æ•°æ®åº“æ“ä½œ

#### Day 5-7: Edge Functions å¼€å‘
- [ ] åˆ›å»º `generate-image` å‡½æ•°
- [ ] åˆ›å»º `check-task` å‡½æ•°
- [ ] åˆ›å»º `get-user-credits` å‡½æ•°
- [ ] åœ¨ Supabase Dashboard è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆAPIMART_KEYï¼‰
- [ ] æµ‹è¯•æ‰€æœ‰ Edge Functions

### Phase 2: å‰ç«¯é›†æˆï¼ˆç¬¬ 2 å‘¨ï¼‰

#### Day 1-2: ç”¨æˆ·è®¤è¯é›†æˆ
- [ ] å¼•å…¥ Supabase SDK
- [ ] æ›¿æ¢ç°æœ‰ç™»å½•ç³»ç»Ÿä¸º Supabase Auth
- [ ] å®ç°æ³¨å†Œ/ç™»å½•/ç™»å‡ºåŠŸèƒ½
- [ ] æµ‹è¯•ä¼šè¯æŒä¹…åŒ–

#### Day 3-4: ç§¯åˆ†ç³»ç»Ÿ UI
- [ ] æ·»åŠ ç§¯åˆ†æ˜¾ç¤ºç»„ä»¶
- [ ] æ·»åŠ æ¶ˆè€—é¢„è§ˆç»„ä»¶
- [ ] åˆ›å»ºå……å€¼ Modalï¼ˆå…ˆåšæ‰‹åŠ¨å……å€¼åŠŸèƒ½ï¼‰
- [ ] åˆ›å»ºäº¤æ˜“å†å²é¡µé¢

#### Day 5-7: API è°ƒç”¨æ”¹é€ 
- [ ] ä¿®æ”¹ `executeSynthesis()` å‡½æ•°ï¼Œè°ƒç”¨ Edge Function
- [ ] å®ç°ä»»åŠ¡çŠ¶æ€è½®è¯¢ï¼ˆå¸¦è‡ªåŠ¨é€€æ¬¾ï¼‰
- [ ] æµ‹è¯•å®Œæ•´ç”Ÿå›¾æµç¨‹
- [ ] æµ‹è¯•ç§¯åˆ†æ‰£é™¤å’Œé€€è¿˜

### Phase 3: é¡¹ç›®ç®¡ç†ä¸å†å²ï¼ˆç¬¬ 3 å‘¨ï¼‰

#### Day 1-3: é¡¹ç›®ç®¡ç†
- [ ] ä¿®æ”¹é¡¹ç›®åˆ—è¡¨ï¼Œä» Supabase åŠ è½½
- [ ] å®ç°é¡¹ç›®åˆ›å»º/åˆ é™¤/é‡å‘½å
- [ ] å°†é¡¹ç›®æ•°æ®ä¿å­˜åˆ° user_projects è¡¨

#### Day 4-5: ç”Ÿæˆå†å²
- [ ] ä¿®æ”¹å†å²è®°å½•åŠ è½½é€»è¾‘
- [ ] ä» generation_logs è¡¨åŠ è½½å†å²
- [ ] å®ç°å†å²è®°å½•çš„åˆ†é¡µå’Œç­›é€‰

#### Day 6-7: çµæ„Ÿç¤¾åŒºé›†æˆ
- [ ] ä¿®æ”¹çµæ„Ÿç¤¾åŒºï¼Œä½¿ç”¨ Supabase Auth
- [ ] å®ç°ç”¨æˆ·ä¸Šä¼ åŠŸèƒ½
- [ ] ä½¿ç”¨ Supabase Storage å­˜å‚¨å›¾ç‰‡
- [ ] ä¿å­˜åˆ° community_posts è¡¨

### Phase 4: æµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆç¬¬ 4 å‘¨ï¼‰

#### Day 1-3: åŠŸèƒ½æµ‹è¯•
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•ï¼šæ³¨å†Œâ†’ç™»å½•â†’å……å€¼â†’ç”Ÿå›¾â†’æŸ¥çœ‹å†å²
- [ ] æµ‹è¯•ç§¯åˆ†ä¸è¶³åœºæ™¯
- [ ] æµ‹è¯•ç”Ÿæˆå¤±è´¥é€€æ¬¾
- [ ] æµ‹è¯•å¹¶å‘è¯·æ±‚

#### Day 4-5: æ€§èƒ½ä¼˜åŒ–
- [ ] ä¼˜åŒ–å›¾ç‰‡åŠ è½½ï¼ˆæ‡’åŠ è½½ã€ç¼©ç•¥å›¾ï¼‰
- [ ] ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢ï¼ˆæ·»åŠ ç´¢å¼•ï¼‰
- [ ] ä¼˜åŒ–å‰ç«¯æ¸²æŸ“ï¼ˆè™šæ‹Ÿæ»šåŠ¨ï¼‰

#### Day 6-7: ä¸Šçº¿å‡†å¤‡
- [ ] æ·»åŠ é”™è¯¯ç›‘æ§ï¼ˆSupabase Logsï¼‰
- [ ] é…ç½®è‡ªå®šä¹‰åŸŸå
- [ ] å‡†å¤‡ä¸Šçº¿æ–‡æ¡£

---

## å…«ã€æˆæœ¬ä¼°ç®—

### 8.1 è¿è¥æˆæœ¬

| é¡¹ç›® | æˆæœ¬ | è¯´æ˜ |
|------|------|------|
| Supabase å…è´¹ç‰ˆ | Â¥0/æœˆ | 500MB æ•°æ®åº“ + 1GB å­˜å‚¨ + 50k MAU |
| APIMart API | æŒ‰æˆæœ¬ | ç”¨æˆ·æ”¯ä»˜å¤šå°‘ï¼Œå°±ç”¨å¤šå°‘ |
| åŸŸå | Â¥50-100/å¹´ | å¯é€‰ |

### 8.2 Supabase å…è´¹é¢åº¦åˆ†æ

**å…è´¹ç‰ˆé™åˆ¶ï¼š**
- 500MB æ•°æ®åº“å­˜å‚¨
- 1GB æ–‡ä»¶å­˜å‚¨
- 50k æœˆæ´»è·ƒç”¨æˆ· (MAU)
- 500k Edge Functions è°ƒç”¨/æœˆ

**é¢„ä¼°ï¼š**
- å‡è®¾ 1000 ä¸ªæ´»è·ƒç”¨æˆ·
- æ¯ç”¨æˆ·æ¯å¤©ç”Ÿæˆ 5 å¼ å›¾ç‰‡
- æ¯æœˆ API è°ƒç”¨ï¼š1000 Ã— 5 Ã— 30 = 150k æ¬¡
- **ç»“è®ºï¼š** å…è´¹ç‰ˆè¶³å¤Ÿæ”¯æ’‘åˆæœŸè¿è¥

### 8.3 å‡çº§æ–¹æ¡ˆï¼ˆè¶…å‡ºå…è´¹é¢åº¦ï¼‰

**Supabase Pro ç‰ˆï¼š** $25/æœˆ
- 8GB æ•°æ®åº“å­˜å‚¨
- 100GB æ–‡ä»¶å­˜å‚¨
- 100k MAU
- 500k Edge Functions è°ƒç”¨/æœˆ

---

## ä¹ã€é£é™©ä¸å¯¹ç­–

### 9.1 æŠ€æœ¯é£é™©

| é£é™© | å¯¹ç­– |
|------|------|
| APIMart API ä¸ç¨³å®š | å®ç°é‡è¯•æœºåˆ¶ + å¤‡ç”¨ API |
| æ•°æ®åº“è¾¾åˆ°ä¸Šé™ | å®šæœŸæ¸…ç†æ—§æ•°æ®ï¼Œå‡çº§å¥—é¤ |
| Edge Functions è¶…æ—¶ | ä¼˜åŒ–ä»£ç ï¼Œä½¿ç”¨å¼‚æ­¥ä»»åŠ¡ |
| å›¾ç‰‡å­˜å‚¨ç©ºé—´ä¸è¶³ | ä½¿ç”¨ CDN + å¯¹è±¡å­˜å‚¨ |

### 9.2 ä¸šåŠ¡é£é™©

| é£é™© | å¯¹ç­– |
|------|------|
| ç”¨æˆ·æ»¥ç”¨ API | æ·»åŠ è¯·æ±‚é¢‘ç‡é™åˆ¶ |
| ç§¯åˆ†è¢«ç›—ç”¨ | åŠ å¼ºä¼šè¯ç®¡ç†ï¼Œå¼‚å¸¸æ£€æµ‹ |
| æ”¯ä»˜çº çº· | è¯¦ç»†è®°å½•æ‰€æœ‰äº¤æ˜“æ—¥å¿— |
| æˆæœ¬è¶…æ”¯ | ç›‘æ§ API è°ƒç”¨é‡ï¼Œè®¾ç½®é¢„ç®—å‘Šè­¦ |

---

## åã€ä¸´æ—¶æ–¹æ¡ˆï¼ˆä¸ä½¿ç”¨æ”¯ä»˜ç³»ç»Ÿï¼‰

å¦‚æœä½ æš‚æ—¶ä¸æƒ³æ¥å…¥æ”¯ä»˜ç³»ç»Ÿï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹æ–¹å¼ï¼š

### æ–¹æ¡ˆ Aï¼šç®¡ç†å‘˜æ‰‹åŠ¨å……å€¼

**æµç¨‹ï¼š**
1. ç”¨æˆ·é€šè¿‡å¾®ä¿¡/æ”¯ä»˜å®è½¬è´¦ç»™ç®¡ç†å‘˜
2. ç”¨æˆ·åœ¨å¹³å°æäº¤å……å€¼ç”³è¯·ï¼ˆå¡«å†™é‡‘é¢ã€è½¬è´¦å‡­è¯ï¼‰
3. ç®¡ç†å‘˜åœ¨ Supabase Dashboard æ‰‹åŠ¨å¢åŠ ç”¨æˆ·ç§¯åˆ†
4. ç”¨æˆ·åˆ·æ–°é¡µé¢çœ‹åˆ°ç§¯åˆ†å¢åŠ 

**å®ç°ï¼š**
```javascript
// ç”¨æˆ·æäº¤å……å€¼ç”³è¯·
async function submitRechargeRequest(amount, proof) {
  await supabase.from('recharge_requests').insert({
    user_id: user.id,
    amount: amount,
    proof_image: proof,
    status: 'pending'
  })

  alert('å……å€¼ç”³è¯·å·²æäº¤ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸')
}

// ç®¡ç†å‘˜å®¡æ ¸ï¼ˆä»…åœ¨ç®¡ç†åå°ï¼‰
async function approveRecharge(requestId) {
  const request = await supabase.from('recharge_requests').select('*').eq('id', requestId).single()

  // è®¡ç®—ç§¯åˆ†ï¼ˆ1å…ƒ â‰ˆ 13.9ç§¯åˆ†ï¼‰
  const credits = Math.floor(request.amount * 13.9)

  await supabase.rpc('add_credits', {
    p_user_id: request.user_id,
    p_amount: credits,
    p_description: `å……å€¼ Â¥${request.amount}`,
    p_type: 'recharge'
  })

  await supabase.from('recharge_requests').update({ status: 'approved' }).eq('id', requestId)
}
```

### æ–¹æ¡ˆ Bï¼šé‚€è¯·å¥–åŠ±æœºåˆ¶

```javascript
// æ–°ç”¨æˆ·æ³¨å†Œå¥–åŠ±
async function onUserSignUp(userId) {
  await supabase.from('user_credits').insert({
    user_id: userId,
    balance: 20,  // èµ é€ 20 ç§¯åˆ†ï¼ˆå¯ç”Ÿæˆ 4 å¼  2K å›¾ç‰‡ï¼‰
    total_recharged: 20
  })
}

// é‚€è¯·å¥½å‹å¥–åŠ±
async function inviteFriend(inviteCode) {
  // ç”Ÿæˆé‚€è¯·ç æ—¶è®°å½•é‚€è¯·å…³ç³»
  await supabase.from('invitations').insert({
    inviter_id: currentUser.id,
    invite_code: inviteCode
  })
}

// å¥½å‹æ³¨å†Œåï¼Œé‚€è¯·è€…è·å¾—å¥–åŠ±
async function onInvitedUserSignUp(userId, inviteCode) {
  const { data: invitation } = await supabase
    .from('invitations')
    .select('*')
    .eq('invite_code', inviteCode)
    .single()

  if (invitation) {
    await supabase.rpc('add_credits', {
      p_user_id: invitation.inviter_id,
      p_amount: 50,
      p_description: 'é‚€è¯·å¥½å‹å¥–åŠ±',
      p_type: 'bonus'
    })
  }
}
```

### æ–¹æ¡ˆ Cï¼šæ¯æ—¥ç­¾åˆ°å¥–åŠ±

```javascript
// æ¯æ—¥ç­¾åˆ°
async function dailyCheckIn() {
  const today = new Date().toISOString().split('T')[0]
  const userId = user.id

  // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç­¾åˆ°
  const { data: existing } = await supabase
    .from('check_in_records')
    .select('*')
    .eq('user_id', userId)
    .eq('date', today)
    .single()

  if (existing) {
    alert('ä»Šå¤©å·²ç»ç­¾åˆ°è¿‡äº†ï¼')
    return
  }

  // ç­¾åˆ°å¹¶èµ é€ç§¯åˆ†
  await supabase.from('check_in_records').insert({
    user_id: userId,
    date: today
  })

  await supabase.rpc('add_credits', {
    p_user_id: userId,
    p_amount: 5,
    p_description: 'æ¯æ—¥ç­¾åˆ°å¥–åŠ±',
    p_type: 'bonus'
  })

  alert('ç­¾åˆ°æˆåŠŸï¼è·å¾— 5 ç§¯åˆ†')
  await loadUserCredits()
}
```

---

## åä¸€ã€æ€»ç»“ä¸å»ºè®®

### æ¨èå®æ–½è·¯å¾„

```
ğŸš€ ç«‹å³å¼€å§‹ï¼ˆç¬¬ 1-2 å‘¨ï¼‰
1. æ³¨å†Œ Supabase è´¦å·
2. åˆ›å»ºæ•°æ®åº“è¡¨
3. å¼€å‘ Edge Functionsï¼ˆgenerate-image, check-taskï¼‰
4. å‰ç«¯é›†æˆ Supabase Auth

ğŸ“ˆ åŸºç¡€åŠŸèƒ½ï¼ˆç¬¬ 3-4 å‘¨ï¼‰
5. å®ç°ç§¯åˆ†ç³»ç»Ÿ UI
6. ä¿®æ”¹ç”Ÿå›¾æµç¨‹ï¼ŒåŠ å…¥ç§¯åˆ†éªŒè¯
7. æµ‹è¯•å®Œæ•´æµç¨‹

ğŸ’¡ å¢å€¼åŠŸèƒ½ï¼ˆç¬¬ 5-6 å‘¨ï¼‰
8. çµæ„Ÿç¤¾åŒºç”¨æˆ·ç³»ç»Ÿ
9. é¡¹ç›®ç®¡ç†äº‘ç«¯åŒæ­¥
10. ä¸´æ—¶å……å€¼æ–¹æ¡ˆï¼ˆæ‰‹åŠ¨å……å€¼/é‚€è¯·å¥–åŠ±ï¼‰

ğŸ’³ æ”¯ä»˜ç³»ç»Ÿï¼ˆæœªæ¥ï¼‰
11. ç”³è¯·è™çš®æ¤’/ PayJS è´¦å·
12. é›†æˆæ”¯ä»˜æ¥å£
13. ä¸Šçº¿å‘å¸ƒ
```

### å…³é”®æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|------|------|--------|
| `supabase/migrations/001_initial_schema.sql` | æ•°æ®åº“è¡¨ç»“æ„ | P0 |
| `supabase/functions/generate-image/index.ts` | å›¾åƒç”Ÿæˆ | P0 |
| `supabase/functions/check-task/index.ts` | ä»»åŠ¡è½®è¯¢ | P0 |
| `supabase/functions/get-user-credits/index.ts` | ç§¯åˆ†æŸ¥è¯¢ | P1 |
| `nanobananaproç”Ÿå›¾å¹³å°.html` | ä¸»åº”ç”¨ï¼ˆéœ€æ”¹é€ ï¼‰ | P0 |
| `inspiration_community.html` | çµæ„Ÿç¤¾åŒºï¼ˆéœ€æ”¹é€ ï¼‰ | P1 |

### æ ¸å¿ƒä¼˜åŠ¿

âœ… **æ— éœ€æœåŠ¡å™¨** - ä½¿ç”¨ Supabase BaaSï¼Œé›¶è¿ç»´
âœ… **æ•°æ®å®‰å…¨** - RLS ä¿æŠ¤ï¼ŒAPI Key ä¸æš´éœ²
âœ… **å¿«é€Ÿä¸Šçº¿** - 2-3 å‘¨å³å¯å®Œæˆæ ¸å¿ƒåŠŸèƒ½
âœ… **æˆæœ¬å¯æ§** - å…è´¹ç‰ˆè¶³å¤Ÿæ”¯æ’‘åˆæœŸè¿è¥
âœ… **å¯æ‰©å±•** - æœªæ¥å¯è½»æ¾æ·»åŠ æ”¯ä»˜ã€åˆ†æç­‰åŠŸèƒ½

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**åˆ›å»ºæ—¥æœŸï¼š** 2025-01-08
**ä½œè€…ï¼š** Claude Code
**é¢„è®¡å¼€å‘å‘¨æœŸï¼š** 4-6 å‘¨
