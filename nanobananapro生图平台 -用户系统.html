<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>规划建筑AI创作平台--by 缪文杰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 新增依赖：Fabric.js(标注), Dexie.js(数据库), CryptoJS(加密) -->
    <!-- 直接使用稳定的 CDN 版本 -->
    <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
    <style>
        :root { --bg: #fdfdfd; --border: #f0f0f0; }
        body { font-family: "Inter", "PingFang SC", sans-serif; background: var(--bg); color: #111; }
        
        /* 深度高光跟随 */
        .spotlight-btn {
            position: relative; overflow: hidden; transition: all 0.3s cubic-bezier(0.2, 0, 0.2, 1);
            background: #fff; border: 1px solid var(--border);
        }
        .spotlight-btn::after {
            content: ""; position: absolute; top: var(--y, 50%); left: var(--x, 50%);
            width: 350px; height: 350px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.18) 0%, transparent 75%);
            transform: translate(-50%, -50%); pointer-events: none; opacity: 0; transition: opacity 0.4s;
        }
        .spotlight-btn:hover::after { opacity: 1; }
        .spotlight-btn:active { transform: scale(0.97); }

        .btn-black { background: #000; color: #fff; border: none; }
        .btn-black::after { background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 75%); }

        .active-tag { background: #000 !important; color: #fff !important; border-color: #000 !important; font-weight: 600; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* 项目列表样式 */
        .project-item { cursor: pointer; padding: 12px 18px; border-radius: 14px; transition: all 0.2s; font-size: 11px; margin-bottom: 6px; color: #888; border: 1px solid transparent; display: flex; align-items: center; justify-content: space-between; group: true; }
        .project-item:hover { background: #f9f9f9; color: #000; }
        .project-item.active { background: white; border-color: #eee; color: #000; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .project-actions { display: none; gap: 8px; }
        .project-item:hover .project-actions { display: flex; }

        /* 预览看板 Modal */
        #imgModal { background: rgba(255, 255, 255, 0.99); backdrop-filter: blur(25px); display: none; flex-direction: row; }
        .modal-image-container { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #fcfcfc; position: relative; cursor: grab; }
        .modal-image-container:active { cursor: grabbing; }
        #modalImg { max-width: 90%; max-height: 90%; user-select: none; pointer-events: none; }
        .modal-sidebar { width: 420px; border-left: 1px solid #f0f0f0; background: white; display: flex; flex-direction: column; padding: 40px; z-index: 10; }
        .zoom-controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; background: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 20px 40px rgba(0,0,0,0.04); z-index: 20; border: 1px solid #f0f0f0; }

        .modal-input-thumb { width: 60px; height: 60px; border-radius: 8px; border: 2px solid transparent; cursor: pointer; object-fit: cover; transition: all 0.2s; }
        .modal-input-thumb.active { border-color: #3b82f6; box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2); }

        /* 标注 Modal 样式 */
        #annotationModal .tool-btn.active { background: #000; border-color: #000; }
        #annotationModal .tool-btn.active i { color: #fff; }
        #annotationModal .canvas-wrapper {
            width: 800px;
            height: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        #annotationModal .canvas-wrapper canvas {
            max-width: 100%;
            max-height: 100%;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="authOverlay" class="fixed inset-0 z-[200] bg-white flex items-center justify-center">
        <div class="w-96 p-10 text-center">
            <div class="w-12 h-12 bg-black rounded-xl flex items-center justify-center shadow-2xl mx-auto mb-8"><i class="fas fa-city text-white text-lg"></i></div>
            <h2 class="text-xs font-bold tracking-[0.5em] uppercase mb-10">Nano Banana Studio</h2>
            <div class="space-y-4 mb-8">
                <input id="userAccount" type="text" placeholder="Design Account / 账号" class="w-full px-5 py-4 bg-gray-50 rounded-2xl text-[12px] focus:ring-1 focus:ring-black outline-none border-none transition-all">
                <input id="userPwd" type="password" placeholder="Password / 密码" class="w-full px-5 py-4 bg-gray-50 rounded-2xl text-[12px] focus:ring-1 focus:ring-black outline-none border-none transition-all">
            </div>
            <button onclick="handleLogin()" class="w-full spotlight-btn btn-black py-4 rounded-2xl text-[11px] font-bold shadow-xl shadow-gray-100 uppercase tracking-widest">进入档案库</button>
        </div>
    </div>

    <div id="imgModal" class="fixed inset-0 z-[100] flex animate-in fade-in duration-300">
        <div class="modal-image-container" id="modalImgBox" onmousedown="startDrag(event)" onmousemove="dragImage(event)" onmouseup="endDrag()" onmouseleave="endDrag()" onwheel="handleWheel(event)">
            <div id="imgWrapper" style="transition: transform 0.1s ease-out; transform-origin: center;"><img id="modalImg" src="" class="shadow-2xl"></div>
            <div class="zoom-controls">
                <button onclick="changeZoom(-0.2)" class="hover:text-blue-500 transition px-2"><i class="fas fa-minus"></i></button>
                <span id="zoomLevel" class="text-[10px] font-mono w-10 text-center">100%</span>
                <button onclick="changeZoom(0.2)" class="hover:text-blue-500 transition px-2"><i class="fas fa-plus"></i></button>
                <button onclick="resetView()" class="ml-2 pl-4 border-l border-gray-100 text-gray-400 hover:text-black transition"><i class="fas fa-undo-alt"></i></button>
            </div>
        </div>
        <aside class="modal-sidebar shadow-2xl">
            <div class="flex justify-between items-center mb-8"><h2 class="text-[10px] font-bold uppercase text-gray-400">Rendering Results</h2><button onclick="closeModal()" class="text-gray-300 hover:text-black"><i class="fas fa-times text-xl"></i></button></div>
            <div class="mb-8"><label class="text-[9px] font-bold text-gray-300 uppercase mb-3 block tracking-widest">User Prompt / 用户提示词</label><div id="modalPrompt" class="text-[12px] leading-relaxed text-gray-600 italic border-l-2 border-gray-100 pl-4 py-2 bg-gray-50/50 rounded-r-xl max-h-48 overflow-y-auto no-scrollbar font-light"></div></div>
            <div class="mb-10"><label class="text-[9px] font-bold text-gray-300 uppercase mb-3 block tracking-widest">Gallery / 画廊</label><div id="modalInputImages" class="flex gap-2 flex-wrap"></div></div>
            <div class="mt-auto"><button id="downloadBtn" onclick="downloadCurrentImage()" class="w-full spotlight-btn btn-black py-4 rounded-2xl text-[11px] font-bold flex items-center justify-center gap-3"><span>下载图片</span><i class="fas fa-download text-[10px]"></i></button></div>
        </aside>
    </div>

    <!-- 标注 Modal -->
    <div id="annotationModal" class="fixed inset-0 z-[150]" style="display: none;">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeAnnotationModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl flex flex-col max-w-5xl w-full max-h-[85vh] overflow-hidden">
                <!-- 头部 -->
                <div class="flex justify-between items-center px-6 py-4 border-b border-gray-100">
                    <h2 class="text-sm font-bold text-gray-700">图片标注 / Annotation</h2>
                    <div class="flex items-center gap-3">
                        <span id="annotationStatus" class="text-[10px] text-gray-400">工具: 画笔</span>
                        <button onclick="closeAnnotationModal()" class="text-gray-400 hover:text-black transition"><i class="fas fa-times text-lg"></i></button>
                    </div>
                </div>

                <!-- Canvas 区域 -->
                <div class="flex-1 bg-gray-50 flex items-center justify-center p-4 relative overflow-hidden">
                    <div class="canvas-wrapper">
                        <canvas id="annotationCanvas" width="800" height="600"></canvas>
                    </div>
                    <div id="canvasPlaceholder" class="absolute text-gray-400 text-sm">请先选择要标注的图片</div>
                </div>

                <!-- 工具栏 -->
                <div class="px-6 py-3 bg-gray-50 border-t border-gray-100">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <!-- 工具选择 -->
                            <div class="flex gap-1 border-r border-gray-200 pr-3">
                                <button onclick="setTool('brush')" id="tool-brush" class="tool-btn active w-10 h-10 rounded-lg bg-white border border-gray-200 hover:border-blue-400 flex items-center justify-center transition-colors" title="画笔 (B)">
                                    <i class="fas fa-paintbrush text-gray-600 text-sm"></i>
                                </button>
                                <button onclick="setTool('lasso')" id="tool-lasso" class="tool-btn w-10 h-10 rounded-lg bg-white border border-gray-200 hover:border-blue-400 flex items-center justify-center transition-colors" title="套索 (L)">
                                    <i class="fas fa-draw-polygon text-gray-600 text-sm"></i>
                                </button>
                                <button onclick="setTool('wand')" id="tool-wand" class="tool-btn w-10 h-10 rounded-lg bg-white border border-gray-200 hover:border-blue-400 flex items-center justify-center transition-colors" title="魔棒 (W)">
                                    <i class="fas fa-wand-magic-sparkles text-gray-600 text-sm"></i>
                                </button>
                                <button onclick="setTool('text')" id="tool-text" class="tool-btn w-10 h-10 rounded-lg bg-white border border-gray-200 hover:border-blue-400 flex items-center justify-center transition-colors" title="文字 (T)">
                                    <i class="fas fa-font text-gray-600 text-sm"></i>
                                </button>
                            </div>

                            <!-- 魔棒模式切换按钮 -->
                            <div class="flex items-center gap-1 border-r border-gray-200 pr-3">
                                <button onclick="toggleWandMode()" id="wandModeBtn" class="px-2 py-1 text-[9px] border rounded bg-white hover:bg-gray-50 transition-colors">
                                    <span id="wandModeText">增加</span>
                                </button>
                            </div>

                            <!-- 参数调节 -->
                            <div class="flex items-center gap-3 border-r border-gray-200 pr-3">
                                <div class="flex items-center gap-2">
                                    <span class="text-[9px] text-gray-500">颜色:</span>
                                    <input type="color" id="brushColor" value="#ff0000" class="w-8 h-8 rounded cursor-pointer border-0">
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-[9px] text-gray-500">大小:</span>
                                    <input type="range" id="brushSize" min="1" max="100" value="20" class="w-20">
                                    <span id="brushSizeValue" class="text-[9px] text-gray-500 w-6">20</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-[9px] text-gray-500">容差:</span>
                                    <input type="range" id="toleranceSlider" min="0" max="100" value="30" class="w-16">
                                    <span id="toleranceValue" class="text-[9px] text-gray-500 w-6">30</span>
                                </div>
                            </div>

                            <!-- 撤销/恢复 -->
                            <div class="flex items-center gap-2">
                                <button onclick="undoAnnotation()" class="w-8 h-8 rounded-lg bg-white border border-gray-200 hover:border-gray-400 flex items-center justify-center transition-colors" title="撤销 (Ctrl+Z)">
                                    <i class="fas fa-undo text-gray-600 text-xs"></i>
                                </button>
                                <button onclick="redoAnnotation()" class="w-8 h-8 rounded-lg bg-white border border-gray-200 hover:border-gray-400 flex items-center justify-center transition-colors" title="恢复 (Ctrl+Y)">
                                    <i class="fas fa-redo text-gray-600 text-xs"></i>
                                </button>
                            </div>
                        </div>

                        <!-- 操作按钮 -->
                        <div class="flex items-center gap-2">
                            <button onclick="clearAnnotation()" class="px-3 py-2 text-[10px] border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                <i class="fas fa-eraser mr-1"></i>清空
                            </button>
                            <button onclick="exportAnnotatedImage()" class="px-4 py-2 text-[10px] bg-black text-white rounded-lg hover:bg-gray-800 transition-colors">
                                <i class="fas fa-check mr-1"></i>完成
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <header class="h-16 border-b border-gray-100 flex items-center justify-between px-10 bg-white/95 backdrop-blur-md z-50">
        <div class="flex items-center gap-4"><div class="w-6 h-6 bg-black rounded-sm flex items-center justify-center shadow-lg"><i class="fas fa-city text-white text-[10px]"></i></div><h1 class="text-xs font-bold tracking-[0.4em] uppercase">Nano Banana <span class="text-gray-400 font-light text-[9px]">PRO</span></h1></div>
        <div class="flex items-center gap-6">
            <div class="flex flex-col items-end gap-1"><span class="text-[8px] font-bold text-gray-400 uppercase tracking-tighter">Auth Key (APIMart)</span><input id="apiMartKey" type="password" placeholder="输入密钥..." class="text-[10px] border-b border-gray-100 focus:border-black outline-none px-2 py-1 transition-all w-56 bg-transparent text-right"></div>
            <div class="flex items-center gap-4 border-l border-gray-100 pl-6"><div class="text-right"><p id="currentUserName" class="text-[10px] font-bold text-gray-800">Designer</p><button onclick="handleLogout()" class="text-[8px] text-gray-300 hover:text-red-400 uppercase">Sign Out</button></div><div class="w-10 h-10 rounded-full bg-gray-50 border border-gray-100 flex items-center justify-center shadow-sm"><i class="fas fa-user-tie text-gray-300"></i></div></div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <aside class="w-72 border-r border-gray-100 flex flex-col bg-white shrink-0">
            <div class="p-8 flex-1 overflow-y-auto no-scrollbar">
                <section class="mb-10">
                    <div class="flex justify-between items-center mb-5"><label class="text-[10px] font-bold uppercase tracking-widest text-gray-400">Archives / 项目</label><button onclick="createNewProject()" class="text-[10px] text-blue-500 hover:text-blue-700 transition"><i class="fas fa-plus-circle"></i></button></div>
                    <div id="projectList"></div>
                </section>
                
                <section class="mb-10">
                    <label class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-3 block">应用场景 / Scenario</label>
                    <div class="grid grid-cols-2 gap-2" id="scenarioGrid">
                        <button onclick="selectScenario('urban-planning', this)" class="scenario-btn flex items-center gap-2 px-3 py-2 text-[10px] border border-gray-100 rounded bg-white hover:border-gray-200 transition-all">
                            <i class="fas fa-city text-gray-400"></i><span>城市规划设计</span>
                        </button>
                        <button onclick="selectScenario('architecture', this)" class="scenario-btn flex items-center gap-2 px-3 py-2 text-[10px] border border-gray-100 rounded bg-white hover:border-gray-200 transition-all">
                            <i class="fas fa-building text-gray-400"></i><span>建筑设计</span>
                        </button>
                        <button onclick="selectScenario('landscape', this)" class="scenario-btn flex items-center gap-2 px-3 py-2 text-[10px] border border-gray-100 rounded bg-white hover:border-gray-200 transition-all">
                            <i class="fas fa-tree text-gray-400"></i><span>景观设计</span>
                        </button>
                        <button onclick="selectScenario('concept', this)" class="scenario-btn flex items-center gap-2 px-3 py-2 text-[10px] border border-gray-100 rounded bg-white hover:border-gray-200 transition-all">
                            <i class="fas fa-lightbulb text-gray-400"></i><span>概念场景图</span>
                        </button>
                    </div>
                </section>

                <section class="mb-10"><label class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-5 block">Ratio / 画面比例</label><div class="grid grid-cols-2 gap-2" id="ratioGrid"></div></section>
                
                <section class="mb-10"><label class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-5 block">Resolution / 精度</label><div class="flex gap-2" id="resGroup"><button onclick="updateSelection('res', '1K', this)" class="res-btn flex-1 py-2 text-[10px] border border-gray-100 rounded active-tag">1K</button><button onclick="updateSelection('res', '2K', this)" class="res-btn flex-1 py-2 text-[10px] border border-gray-100 rounded">2K</button><button onclick="updateSelection('res', '4K', this)" class="res-btn flex-1 py-2 text-[10px] border border-gray-100 rounded">4K</button></div></section>
                
                <section><label class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-5 block">Quantity / 生成数量</label><div class="flex gap-2" id="nGroup"><button onclick="updateSelection('n', 1, this)" class="n-btn flex-1 py-2 text-[10px] border border-gray-100 rounded active-tag">1张</button><button onclick="updateSelection('n', 2, this)" class="n-btn flex-1 py-2 text-[10px] border border-gray-100 rounded">2张</button><button onclick="updateSelection('n', 3, this)" class="n-btn flex-1 py-2 text-[10px] border border-gray-100 rounded">3张</button><button onclick="updateSelection('n', 4, this)" class="n-btn flex-1 py-2 text-[10px] border border-gray-100 rounded">4张</button></div></section>
            </div>
        </aside>

        <section class="flex-1 flex flex-col bg-[#fafafa] relative overflow-hidden">
            <div id="historyTrack" class="flex-1 p-12 no-scrollbar flex flex-row items-start gap-10 overflow-x-auto scroll-behavior-smooth">
                <div class="m-auto text-center opacity-10 select-none empty-hint"><p class="text-[11px] font-light tracking-[1em] uppercase tracking-widest italic">Synthetic Evolution Timeline</p></div>
            </div>

            <div class="p-8 w-full max-w-5xl mx-auto z-20">
                <div class="bg-white rounded-[2.5rem] shadow-[0_40px_100px_rgba(0,0,0,0.03)] border border-gray-100 p-6">
                    <div id="imageTray" class="flex gap-4 mb-4 hidden no-scrollbar overflow-x-auto pb-1"></div>
                    <div id="styleImageTray" class="flex gap-4 mb-4 hidden no-scrollbar overflow-x-auto pb-1 border-t border-gray-100 pt-3">
                        <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">风格参考 / Style Reference</span>
                    </div>
                    <textarea id="promptInput" placeholder="描述方案愿景，将自动保存至当前项目..." class="w-full bg-transparent border-none focus:ring-0 text-[13px] text-gray-800 placeholder:text-gray-300 resize-none h-24 font-light leading-relaxed"></textarea>
                    <div class="flex items-center justify-between border-t border-gray-50 pt-5 mt-2">
                        <div class="flex items-center gap-3">
                            <button onclick="refineWithNarrativeAI()" id="magicBtn" class="spotlight-btn px-6 py-2.5 rounded-2xl text-[10px] flex items-center gap-2 font-bold text-gray-500 hover:text-black transition-colors"><i class="fas fa-wand-magic-sparkles text-blue-500"></i><span>提示词AI优化</span></button>
                            <label class="spotlight-btn px-6 py-2.5 rounded-2xl text-[10px] flex items-center gap-2 font-bold text-gray-500 hover:text-black cursor-pointer transition-colors"><i class="fas fa-image"></i><span>上传底图</span><input type="file" multiple accept="image/*" class="hidden" onchange="captureAssets(this.files)"></label>
                            <label class="spotlight-btn px-4 py-2.5 rounded-2xl text-[9px] flex items-center gap-1.5 font-bold text-purple-500 hover:text-purple-700 cursor-pointer transition-colors border border-purple-100"><i class="fas fa-palette"></i><span>风格参考</span><input type="file" multiple accept="image/*" class="hidden" onchange="captureStyleAssets(this.files)"></label>
                        </div>
                        <button onclick="executeSynthesis()" class="spotlight-btn btn-black px-12 py-3.5 rounded-2xl text-[10px] font-bold flex items-center gap-3 shadow-2xl"><span>开始生图</span><i class="fas fa-chevron-right text-[8px]"></i></button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        const INTERNAL_SF_KEY = 'sk-rudcrnbhwykshkezbwaojyucwlqrfmcoebnmcootdgdehcqc';
        let platformState = {
            ratio: '1:1',
            res: '1K',
            n: 1,
            currentRefImgs: [],
            styleReferenceImages: [],
            currentAnnotatedImage: null,
            currentProject: '默认项目',
            history: [],
            selectedTags: { scenario: '', ratio: '1:1', quality: '1K' }
        };
        let projects = ['默认项目'];

        // ========== 常量与配置 ==========
        const API_ENDPOINTS = {
            generations: 'https://api.apimart.ai/v1/images/generations',
            tasks: 'https://api.apimart.ai/v1/tasks/'
        };
        const MAX_HISTORY = 50;
        const SESSION_DURATION = 7 * 24 * 60 * 60 * 1000; // 7天

        // ========== 数据层 ==========
        const db = new Dexie('NanoBananaDB');
        db.version(1).stores({
            projects: '++id, userId, name, createdAt',
            generations: '++id, projectId, userId, status, createdAt',
            images: '++id, type, createdAt',
            users: 'id, lastLoginAt'
        });

        // 数据操作辅助函数
        async function saveProjectToDB(name, userId) {
            return await db.projects.add({
                name,
                userId,
                createdAt: new Date()
            });
        }

        async function loadProjectsFromDB(userId) {
            return await db.projects.where('userId').equals(userId).toArray();
        }

        async function saveUserToDB(user) {
            const existing = await db.users.get(user);
            const userData = {
                id: user,
                lastLoginAt: new Date()
            };
            if (existing) {
                await db.users.put(userData);
            } else {
                await db.users.add(userData);
            }
        }

        async function saveGenerationToDB(generation) {
            return await db.generations.add(generation);
        }

        async function loadGenerationsFromDB(userId, projectId) {
            return await db.generations
                .where('userId').equals(userId)
                .and(g => g.projectId === projectId)
                .reverse()
                .toArray();
        }

        // 密码加密
        function hashPassword(password) {
            return CryptoJS.SHA256(password).toString();
        }

        // API密钥加密
        function encryptApiKey(apiKey) {
            return CryptoJS.AES.encrypt(apiKey, 'nano-banana-secret').toString();
        }

        function decryptApiKey(encryptedKey) {
            const bytes = CryptoJS.AES.decrypt(encryptedKey, 'nano-banana-secret');
            return bytes.toString(CryptoJS.enc.Utf8);
        }

        // --- 核心：用户系统与项目增强 (新增删除、重命名) ---
        async function handleLogin() {
            try {
                console.log('开始登录...');

                // 检查依赖库是否加载
                if (typeof CryptoJS === 'undefined') {
                    alert('CryptoJS 库未加载，请刷新页面重试');
                    console.error('CryptoJS 未加载');
                    return;
                }
                if (typeof Dexie === 'undefined') {
                    alert('Dexie.js 库未加载，请刷新页面重试');
                    console.error('Dexie 未加载');
                    return;
                }

                const user = document.getElementById('userAccount').value;
                const pwd = document.getElementById('userPwd').value;
                if(!user || !pwd) return alert("请输入完整账号和密码");

                console.log('用户输入:', user);

                // 保存用户到数据库
                await saveUserToDB(user);
                console.log('用户已保存到数据库');

                // 创建会话令牌并保存到 localStorage
                const sessionToken = CryptoJS.lib.WordArray.random(32).toString();
                const sessionData = {
                    userId: user,
                    token: sessionToken,
                    expiresAt: Date.now() + SESSION_DURATION
                };
                localStorage.setItem('nano_session', JSON.stringify(sessionData));
                console.log('会话已创建');

                // 保存加密的 API 密钥（如果有）
                const apiKey = document.getElementById('apiMartKey').value;
                if(apiKey) {
                    localStorage.setItem('nano_api_key', encryptApiKey(apiKey));
                }

                document.getElementById('currentUserName').innerText = user;
                document.getElementById('authOverlay').style.display = 'none';
                console.log('登录遮罩已隐藏');

                await initData(user);
                console.log('用户数据已初始化');
                alert('登录成功！');
            } catch (error) {
                console.error('登录失败:', error);
                alert('登录失败: ' + error.message);
            }
        }

        async function initData(user) {
            // 尝试从 IndexedDB 加载数据
            try {
                const dbProjects = await loadProjectsFromDB(user);
                if(dbProjects.length > 0) {
                    projects = dbProjects.map(p => p.name);
                }
            } catch(e) {
                console.log('IndexedDB 不可用，使用 localStorage');
                // 降级到 localStorage
                const savedP = localStorage.getItem(`projects_${user}`);
                const savedH = localStorage.getItem(`history_${user}`);
                if(savedP) projects = JSON.parse(savedP);
                if(savedH) platformState.history = JSON.parse(savedH);
            }

            renderProjectList();
            switchProject(platformState.currentProject);

            // 恢复 API 密钥
            const encryptedKey = localStorage.getItem('nano_api_key');
            if(encryptedKey) {
                try {
                    const decryptedKey = decryptApiKey(encryptedKey);
                    document.getElementById('apiMartKey').value = decryptedKey;
                } catch(e) {
                    console.log('API 密钥解密失败');
                }
            }
        }

        // 检查会话是否有效
        async function checkSession() {
            try {
                const sessionStr = localStorage.getItem('nano_session');
                if(!sessionStr) {
                    console.log('没有找到会话，显示登录界面');
                    return false;
                }

                const session = JSON.parse(sessionStr);
                if(Date.now() > session.expiresAt) {
                    localStorage.removeItem('nano_session');
                    console.log('会话已过期，显示登录界面');
                    return false;
                }

                // 从数据库恢复用户信息
                const user = session.userId;
                console.log('找到有效会话:', user);
                document.getElementById('currentUserName').innerText = user;
                document.getElementById('authOverlay').style.display = 'none';
                await initData(user);
                return true;
            } catch(e) {
                console.error('检查会话时出错:', e);
                return false;
            }
        }

        // 页面加载时检查会话
        (async function() {
            console.log('页面初始化开始...');
            console.log('CryptoJS:', typeof CryptoJS);
            console.log('Dexie:', typeof Dexie);
            console.log('fabric:', typeof fabric);

            await checkSession();
            console.log('页面初始化完成');
        })();

        function createNewProject() {
            const name = prompt("项目名称");
            if(name && !projects.includes(name)) { projects.push(name); saveAllData(); renderProjectList(); switchProject(name); }
        }

        function deleteProject(name, e) {
            e.stopPropagation();
            if(name === '默认项目') return alert("默认项目不可删除");
            if(confirm(`确定删除项目 "${name}" 吗？该项目下的所有图片记录将被一并清除。`)) {
                projects = projects.filter(p => p !== name);
                platformState.history = platformState.history.filter(h => h.project !== name);
                if(platformState.currentProject === name) platformState.currentProject = '默认项目';
                saveAllData(); renderProjectList(); switchProject(platformState.currentProject);
            }
        }

        function renameProject(name, e) {
            e.stopPropagation();
            const newName = prompt("请输入新的项目名称", name);
            if(newName && newName !== name && !projects.includes(newName)) {
                projects = projects.map(p => p === name ? newName : p);
                platformState.history = platformState.history.map(h => {
                    if(h.project === name) h.project = newName;
                    return h;
                });
                if(platformState.currentProject === name) platformState.currentProject = newName;
                saveAllData(); renderProjectList(); switchProject(platformState.currentProject);
            }
        }

        function renderProjectList() {
            const list = document.getElementById('projectList');
            list.innerHTML = '';
            projects.forEach(p => {
                const div = document.createElement('div');
                div.className = `project-item ${platformState.currentProject === p ? 'active' : ''}`;
                div.innerHTML = `
                    <div class="flex items-center"><i class="far fa-folder-open mr-3"></i> ${p}</div>
                    <div class="project-actions">
                        <i onclick="renameProject('${p}', event)" class="fas fa-pen hover:text-blue-500 transition-colors px-1" title="重命名"></i>
                        <i onclick="deleteProject('${p}', event)" class="fas fa-trash-alt hover:text-red-500 transition-colors px-1" title="删除"></i>
                    </div>`;
                div.onclick = () => switchProject(p);
                list.appendChild(div);
            });
        }

        function switchProject(name) {
            platformState.currentProject = name;
            renderProjectList();
            const track = document.getElementById('historyTrack');
            track.innerHTML = '';
            const filtered = platformState.history.filter(h => h.project === name);
            if(filtered.length === 0) {
                track.innerHTML = '<div class="m-auto text-center opacity-10 select-none empty-hint"><p class="text-[11px] font-light tracking-[1em] uppercase tracking-widest italic">Project Records Empty</p></div>';
            } else {
                filtered.forEach(item => {
                    const card = createHistoryCard(item);
                    track.appendChild(card);
                    if(item.resultUrl) fillSuccessCard(card, item.resultUrl, item);
                });
            }
        }

        function saveAllData() {
            const user = document.getElementById('currentUserName').innerText;
            localStorage.setItem(`projects_${user}`, JSON.stringify(projects));
            localStorage.setItem(`history_${user}`, JSON.stringify(platformState.history));
        }

        // --- 核心：查看与平移 (保持 V5.0 手感) ---
        let scale = 1, isDragging = false, startX, startY, translateX = 0, translateY = 0;
        function openModal(resultUrl, prompt = '', config = '', inputImgList = []) {
            if(!resultUrl) return;
            resetView();
            document.getElementById('modalImg').src = resultUrl;
            document.getElementById('modalPrompt').innerText = `"${prompt}"`;
            const cfgArr = config.split(' | ');
            document.getElementById('modalInputImages').innerHTML = '';
            const allImgs = [{url: resultUrl, type: 'result'}, ...inputImgList.map(url => ({url, type: 'ref'}))];
            allImgs.forEach((item, idx) => {
                const thumb = document.createElement('img');
                thumb.src = item.url; thumb.className = `modal-input-thumb ${idx === 0 ? 'active' : ''}`;
                thumb.onclick = () => {
                    document.querySelectorAll('.modal-input-thumb').forEach(t => t.classList.remove('active'));
                    thumb.classList.add('active'); document.getElementById('modalImg').src = item.url; resetView();
                };
                document.getElementById('modalInputImages').appendChild(thumb);
            });
            document.getElementById('imgModal').style.display = 'flex';
        }
        function resetView() { scale = 1; translateX = 0; translateY = 0; updateTransform(); }
        function updateTransform() { document.getElementById('imgWrapper').style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`; document.getElementById('zoomLevel').innerText = Math.round(scale * 100) + '%'; }
        function startDrag(e) { e.preventDefault(); isDragging = true; startX = e.clientX - translateX; startY = e.clientY - translateY; }
        function dragImage(e) { if (!isDragging) return; translateX = e.clientX - startX; translateY = e.clientY - startY; updateTransform(); }
        function endDrag() { isDragging = false; }
        function handleWheel(e) { e.preventDefault(); scale = Math.min(Math.max(0.4, scale + (e.deltaY > 0 ? -0.1 : 0.1)), 6); updateTransform(); }
        function changeZoom(delta) { scale = Math.min(Math.max(0.4, scale + delta), 6); updateTransform(); }
        function closeModal() { document.getElementById('imgModal').style.display = 'none'; }
        
        async function downloadCurrentImage() {
            const url = document.getElementById('modalImg').src;
            const r = await fetch(url); const blob = await r.blob();
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob);
            link.download = `Nano_Design_${Date.now()}.png`; link.click();
        }

        // --- 核心：系统提示词逻辑 (严禁修改) ---
        async function refineWithNarrativeAI() {
            const field = document.getElementById('promptInput'); const btn = document.getElementById('magicBtn');
            if(!field.value.trim()) return alert("请输入想法");
            const original = field.value; btn.disabled = true; field.value = "AI正在进行提示词优化…...";
            try {
                const response = await fetch('https://api.siliconflow.cn/v1/chat/completions', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${INTERNAL_SF_KEY}` },
                    body: JSON.stringify({
                        model: "Qwen/Qwen2.5-72B-Instruct",
                        messages: [
                            { role: "system", content: "你是一位深耕于建筑与城市设计领域的效果图渲染大师，擅长效果图渲染的场景细节、氛围细节、光影细节等。你擅长将用户输入的提示词 。你的任务是深度理解用户原始提示词并在此基础上进行合理优化拓展，并将用户输入的提示词重写为更符合 Nano Banana 理解与执行逻辑的专业提示词。你的输出应当让：图像更稳定；细节更清晰；风格更可控；但看起来仍然是用户自己写的。直接输出改写后的提示词内容，不输出任何解释。" },
                            { role: "user", content: `${original}` }
                        ], temperature: 0.5
                    })
                });
                const res = await response.json(); field.value = res.choices[0].message.content;
            } catch (e) { field.value = original; } finally { btn.disabled = false; }
        }

        // 参数选择互斥逻辑修复
        function updateSelection(type, val, el) {
            document.querySelectorAll(`.${type}-btn`).forEach(btn => btn.classList.remove('active-tag'));
            el.classList.add('active-tag'); platformState[type] = val;
        }

        // ========== 结构化标签选择 ==========
        function selectScenario(scenario, el) {
            document.querySelectorAll('.scenario-btn').forEach(btn => btn.classList.remove('active-tag'));
            el.classList.add('active-tag');
            platformState.selectedTags.scenario = scenario;
        }

        // 画面比例初始化
        const rConfigs = ["1:1", "3:2", "2:3", "4:3", "3:4", "16:9", "9:16", "21:9", "4:5", "5:4"];
        const ratioGrid = document.getElementById('ratioGrid');
        rConfigs.forEach(r => {
            const b = document.createElement('button'); b.innerText = r; b.className = `ratio-btn py-2 text-[10px] border border-gray-50 rounded bg-white hover:border-gray-200 transition-all ${r==='1:1'?'active-tag':''}`;
            b.onclick = () => { document.querySelectorAll('.ratio-btn').forEach(el => el.classList.remove('active-tag')); b.classList.add('active-tag'); platformState.ratio = r; };
            ratioGrid.appendChild(b);
        });

        async function executeSynthesis() {
            const key = document.getElementById('apiMartKey').value; if(!key) return alert("请输入生图引擎密钥");
            const prompt = document.getElementById('promptInput').value;
            const refImgs = platformState.currentRefImgs.map(img => img.b64);
            const styleImgs = platformState.styleReferenceImages.map(img => img.b64);
            const annotatedImg = platformState.currentAnnotatedImage;

            // 合并所有参考图
            const allImgs = [...refImgs, ...styleImgs];
            if(annotatedImg) allImgs.push(annotatedImg);

            for(let i=0; i < platformState.n; i++) {
                const snapshot = {
                    id: Date.now() + Math.random(),
                    project: platformState.currentProject,
                    dt: new Date().toLocaleString('zh-CN', { hour12: false }),
                    p: prompt,
                    cfg: `${platformState.ratio} | ${platformState.res}`,
                    tags: {...platformState.selectedTags},
                    imgs: allImgs,
                    resultUrl: null
                };
                platformState.history.push(snapshot);
                saveAllData();
                switchProject(platformState.currentProject);

                try {
                    const response = await fetch('https://api.apimart.ai/v1/images/generations', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${key}`
                        },
                        body: JSON.stringify({
                            model: "gemini-3-pro-image-preview",
                            prompt: prompt,
                            size: platformState.ratio,
                            n: 1,
                            resolution: platformState.res,
                            image_urls: allImgs.length > 0 ? allImgs.map(url => ({url})) : undefined
                        })
                    });
                    const res = await response.json();
                    if(res.code === 200) monitorTask(res.data[0].task_id, key, snapshot);
                } catch (e) {
                    console.error('生图失败:', e);
                    alert('生图失败，请检查网络连接和 API 密钥');
                }
            }
        }

        async function monitorTask(tid, key, snapshot) {
            const timer = setInterval(async () => {
                try {
                    const r = await fetch(`https://api.apimart.ai/v1/tasks/${tid}?language=zh`, { headers: { 'Authorization': `Bearer ${key}` } });
                    const res = await r.json();
                    if(res.code === 200 && res.data.status === 'completed') {
                        clearInterval(timer); snapshot.resultUrl = res.data.result.images[0].url[0];
                        saveAllData(); switchProject(platformState.currentProject);
                    }
                } catch(e) {}
            }, 3000);
        }

        function createHistoryCard(meta) {
            const div = document.createElement('div');
            div.className = "w-80 flex-none bg-white rounded-[2.5rem] border border-gray-100 shadow-sm flex flex-col overflow-hidden animate-in fade-in slide-in-from-left-4 transition-all duration-500 hover:shadow-2xl";
            div.innerHTML = `
                <div class="h-80 bg-gray-50 flex items-center justify-center relative group overflow-hidden">
                    <div class="spinner w-5 h-5 border border-gray-200 border-t-black rounded-full animate-spin"></div>
                    <img class="final-img w-full h-full object-cover hidden transition-all duration-1000 group-hover:scale-110">
                    ${meta.imgs.length > 0 ? `<div onclick="openModal('${meta.imgs[0]}', '设计参考图', 'Reference', [${meta.imgs.map(i=>`'${i}'`).join(',')}])" class="absolute bottom-4 left-4 w-12 h-12 rounded-xl border-2 border-white shadow-xl overflow-hidden z-10 hover:scale-110 transition cursor-zoom-in"><img src="${meta.imgs[0]}" class="w-full h-full object-cover"></div>` : ''}
                    <div class="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 flex items-center justify-center transition pointer-events-none"><button class="view-btn hidden bg-white text-black text-[10px] font-bold px-6 py-2.5 rounded-full shadow-2xl pointer-events-auto active:scale-95 transition-all">查看方案详情</button></div>
                </div>
                <div class="p-6 flex flex-col gap-4">
                    <div class="flex justify-between items-center border-b border-gray-50 pb-3"><span class="text-[9px] text-gray-400 font-mono">${meta.dt}</span><span class="status-tag text-[9px] font-bold text-gray-800 italic">Rendering</span></div>
                    <p class="prompt-text text-[11px] text-gray-800 leading-relaxed line-clamp-2 font-light italic cursor-pointer hover:text-blue-500" onclick="this.classList.toggle('line-clamp-2')">"${meta.p}"</p>
                    <span class="text-[9px] font-mono text-gray-300 uppercase font-bold">${meta.cfg}</span>
                </div>`;
            return div;
        }

        function fillSuccessCard(card, url, meta) {
            card.querySelector('.spinner').classList.add('hidden');
            const fImg = card.querySelector('.final-img'); fImg.src = url; fImg.classList.remove('hidden');
            card.querySelector('.status-tag').innerText = 'Success'; card.querySelector('.status-tag').classList.replace('text-gray-800', 'text-green-500');
            const vBtn = card.querySelector('.view-btn'); vBtn.classList.remove('hidden'); vBtn.onclick = () => openModal(url, meta.p, meta.cfg, meta.imgs);
        }

        function captureAssets(files) {
            const tray = document.getElementById('imageTray'); tray.classList.remove('hidden');
            Array.from(files).forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const id = Date.now() + idx;
                    const b64 = e.target.result;
                    const div = document.createElement('div');
                    div.id = `up-${id}`;
                    div.className = "relative group w-14 h-14 rounded-xl overflow-hidden border border-gray-100 shrink-0 shadow-sm transition-all hover:scale-105 cursor-pointer";
                    div.innerHTML = `
                        <img src="${b64}" class="w-full h-full object-cover" data-annotation-img="${id}">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex flex items-center justify-center gap-1">
                            <button class="preview-btn text-white text-[8px] bg-blue-500/80 rounded px-1.5 py-0.5 hover:bg-blue-500 transition" title="预览" data-img-id="${id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="annotate-btn text-white text-[8px] bg-black/50 rounded px-1.5 py-0.5 hover:bg-black/80 transition" title="标注" data-img-id="${id}">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button class="delete-btn text-white text-[8px] bg-red-500/80 rounded px-1.5 py-0.5 hover:bg-red-500 transition" title="删除" data-img-id="${id}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    tray.appendChild(div);
                    platformState.currentRefImgs.push({id, b64});

                    // 绑定事件监听器
                    const img = div.querySelector('img');
                    img.addEventListener('click', () => openModal(b64, '底图预览', '', [b64]));

                    const previewBtn = div.querySelector('.preview-btn');
                    previewBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openModal(b64, '底图预览', '', [b64]);
                    });

                    const annotateBtn = div.querySelector('.annotate-btn');
                    annotateBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openAnnotationModal(b64);
                    });

                    const deleteBtn = div.querySelector('.delete-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeAsset(id);
                    });
                };
                reader.readAsDataURL(file);
            });
        }
        function removeAsset(id) { document.getElementById(`up-${id}`).remove(); platformState.currentRefImgs = platformState.currentRefImgs.filter(i => i.id != id); if(platformState.currentRefImgs.length === 0) document.getElementById('imageTray').classList.add('hidden'); }

        // ========== 风格参考图处理 ==========
        function captureStyleAssets(files) {
            const tray = document.getElementById('styleImageTray'); tray.classList.remove('hidden');
            Array.from(files).forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const id = 'style-' + Date.now() + idx;
                    const b64 = e.target.result;
                    const div = document.createElement('div');
                    div.id = `style-${id}`;
                    div.className = "relative group w-14 h-14 rounded-xl overflow-hidden border-2 border-purple-200 shrink-0 shadow-sm transition-all hover:scale-105";
                    div.innerHTML = `<img src="${b64}" class="w-full h-full object-cover"><div class="delete-style-btn absolute inset-0 bg-purple-500/40 opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition-opacity"><i class="fas fa-times text-white text-[9px]"></i></div>`;
                    tray.appendChild(div);
                    platformState.styleReferenceImages.push({id, b64});

                    // 绑定删除事件
                    const deleteBtn = div.querySelector('.delete-style-btn');
                    deleteBtn.addEventListener('click', () => removeStyleAsset(id));
                };
                reader.readAsDataURL(file);
            });
        }

        function removeStyleAsset(id) {
            document.getElementById(`style-${id}`).remove();
            platformState.styleReferenceImages = platformState.styleReferenceImages.filter(i => i.id != id);
            if(platformState.styleReferenceImages.length === 0) {
                document.getElementById('styleImageTray').classList.add('hidden');
            }
        }

        // ========== 标注功能 ==========
        let annotationCanvas;
        let currentTool = 'brush';
        let isCanvasReady = false;
        let backgroundImageElement = null; // 存储背景图片元素

        const annotationState = {
            brushColor: '#ff0000',
            brushSize: 20,
            tolerance: 30,
            isDrawing: false,
            polygonPoints: [],
            undoStack: [],
            redoStack: [],
            currentImageSrc: null,
            imageLoaded: false,
            wandMode: 'add',
            isSavingState: false  // 防止重复保存状态
        };

        // 套索工具专用变量
        let polygonLines = [];
        let tempLine = null;

        // 打开标注 Modal
        async function openAnnotationModal(imageSrc) {
            console.log('=== openAnnotationModal 被调用 ===');

            // 验证图片源
            if(!imageSrc || typeof imageSrc !== 'string' || !imageSrc.startsWith('data:image')) {
                alert('图片源无效，请重新选择图片');
                return;
            }

            // 先清理旧状态
            if(annotationCanvas) {
                try {
                    annotationCanvas.dispose();
                } catch(e) {}
                annotationCanvas = null;
            }

            // 重置状态
            isCanvasReady = false;
            annotationState.imageLoaded = false;
            annotationState.currentImageSrc = null;
            annotationState.undoStack = [];
            annotationState.redoStack = [];
            annotationState.polygonPoints = [];
            polygonLines = [];
            tempLine = null;
            backgroundImageElement = null;

            // 显示 Modal
            const modal = document.getElementById('annotationModal');
            modal.style.display = 'block';
            document.getElementById('annotationStatus').innerText = '正在初始化...';

            // 重置 canvas placeholder
            const placeholder = document.getElementById('canvasPlaceholder');
            if(placeholder) {
                placeholder.style.display = 'block';
                placeholder.innerText = '正在加载图片...';
            }

            // 初始化 Canvas
            setTimeout(() => {
                initAnnotationCanvas(imageSrc);
            }, 50);
        }

        function closeAnnotationModal() {
            document.getElementById('annotationModal').style.display = 'none';
            if(annotationCanvas) {
                try {
                    annotationCanvas.dispose();
                } catch(e) {}
                annotationCanvas = null;
            }
            isCanvasReady = false;
            currentTool = 'brush';
            backgroundImageElement = null;
        }

        // 初始化 Canvas
        function initAnnotationCanvas(imageSrc) {
            console.log('=== 开始初始化标注 Canvas ===');

            // 清理旧 Canvas
            if(annotationCanvas) {
                try {
                    annotationCanvas.off();
                    annotationCanvas.dispose();
                } catch(e) {}
                annotationCanvas = null;
            }

            // 获取 Canvas 元素
            const canvasEl = document.getElementById('annotationCanvas');
            if(!canvasEl) {
                alert('Canvas 元素未找到，请刷新页面重试');
                return;
            }

            // 创建 Fabric Canvas
            try {
                annotationCanvas = new fabric.Canvas('annotationCanvas', {
                    width: 800,
                    height: 600,
                    backgroundColor: '#f5f5f5',
                    selection: false,
                    renderOnAddRemove: true  // 改为 true，自动渲染
                });
            } catch(e) {
                alert('Canvas 初始化失败: ' + e.message);
                return;
            }

            // 加载图片
            if(imageSrc) {
                annotationState.currentImageSrc = imageSrc;
                annotationState.imageLoaded = false;
                document.getElementById('annotationStatus').innerText = '正在加载图片...';

                // 使用原生 Image 对象加载，更可靠
                const imgObj = new Image();
                imgObj.onload = function() {
                    console.log('✅ 图片加载成功！尺寸:', imgObj.width, 'x', imgObj.height);

                    const scale = Math.min(800 / imgObj.width, 600 / imgObj.height);
                    const fabricImg = new fabric.Image(imgObj, {
                        scaleX: scale,
                        scaleY: scale,
                        left: (800 - imgObj.width * scale) / 2,
                        top: (600 - imgObj.height * scale) / 2,
                        selectable: false,
                        evented: false
                    });

                    annotationCanvas.setBackgroundImage(fabricImg, function() {
                        annotationCanvas.renderAll();
                        annotationState.imageLoaded = true;
                        backgroundImageElement = fabricImg;

                        document.getElementById('canvasPlaceholder').style.display = 'none';

                        bindAnnotationEvents();
                        setupBrushTool();
                        isCanvasReady = true;
                        document.getElementById('annotationStatus').innerText = '工具: 画笔 - 就绪';
                        console.log('=== Canvas 初始化完成 ===');

                        // 保存初始状态
                        saveAnnotationState();
                    });
                };

                imgObj.onerror = function() {
                    console.error('❌ 图片加载失败');
                    document.getElementById('annotationStatus').innerText = '图片加载失败';
                    alert('图片加载失败，请重试');
                };

                imgObj.src = imageSrc;
            }
        }

        // 集中式事件处理
        function bindAnnotationEvents() {
            // 清除旧的事件监听
            annotationCanvas.off('mouse:down');
            annotationCanvas.off('mouse:move');
            annotationCanvas.off('mouse:dblclick');
            annotationCanvas.off('path:created');

            // 鼠标按下事件
            annotationCanvas.on('mouse:down', function(options) {
                if(!isCanvasReady) return;
                const pointer = annotationCanvas.getPointer(options.e);

                switch(currentTool) {
                    case 'lasso':
                        handleLassoClick(pointer);
                        break;
                    case 'wand':
                        performMagicWand(pointer.x, pointer.y);
                        break;
                    case 'text':
                        handleTextClick(pointer);
                        break;
                }
            });

            // 鼠标移动事件
            annotationCanvas.on('mouse:move', function(options) {
                if(!isCanvasReady) return;
                if(currentTool === 'lasso' && annotationState.polygonPoints.length > 0) {
                    const pointer = annotationCanvas.getPointer(options.e);
                    updateLassoPreview(pointer);
                }
            });

            // 双击事件
            annotationCanvas.on('mouse:dblclick', function(options) {
                if(!isCanvasReady) return;
                if(currentTool === 'lasso' && annotationState.polygonPoints.length >= 3) {
                    completePolygon();
                }
            });

            // 画笔绘制完成后自动保存状态
            annotationCanvas.on('path:created', function() {
                setTimeout(() => saveAnnotationState(), 50);
            });
        }

        function saveAnnotationState() {
            if(!annotationCanvas || !isCanvasReady || annotationState.isSavingState) return;

            annotationState.isSavingState = true;
            const state = JSON.stringify(annotationCanvas.toJSON());

            // 避免重复保存相同状态
            if(annotationState.undoStack.length > 0) {
                const lastState = annotationState.undoStack[annotationState.undoStack.length - 1];
                if(lastState === state) {
                    annotationState.isSavingState = false;
                    return;
                }
            }

            annotationState.undoStack.push(state);
            if(annotationState.undoStack.length > MAX_HISTORY) {
                annotationState.undoStack.shift();
            }
            annotationState.redoStack = [];
            annotationState.isSavingState = false;

            console.log('状态已保存，撤销栈深度:', annotationState.undoStack.length);
        }

        // 画笔工具
        function setupBrushTool() {
            currentTool = 'brush';
            document.getElementById('annotationStatus').innerText = isCanvasReady ? '工具: 画笔 - 就绪' : '工具: 画笔 - 加载中...';
            if(!isCanvasReady) return;

            annotationCanvas.isDrawingMode = true;
            annotationCanvas.freeDrawingBrush = new fabric.PencilBrush(annotationCanvas);
            updateBrushSettings();
        }

        function setTool(tool) {
            if(!isCanvasReady) {
                document.getElementById('annotationStatus').innerText = '请等待图片加载完成...';
                return;
            }

            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tool-${tool}`).classList.add('active');

            annotationCanvas.isDrawingMode = false;
            annotationCanvas.selection = false;

            switch(tool) {
                case 'brush':
                    setupBrushTool();
                    break;
                case 'lasso':
                    setupLassoTool();
                    break;
                case 'wand':
                    setupWandTool();
                    break;
                case 'text':
                    setupTextTool();
                    break;
            }
        }

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            // 只有在标注 Modal 打开时才响应快捷键
            const modal = document.getElementById('annotationModal');
            if(modal.style.display !== 'block') return;

            // Ctrl+Z 撤销
            if(e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undoAnnotation();
                return;
            }

            // Ctrl+Y 或 Ctrl+Shift+Z 恢复
            if((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'z')) {
                e.preventDefault();
                redoAnnotation();
                return;
            }

            // Delete 删除选中对象
            if(e.key === 'Delete' || e.key === 'Backspace') {
                const activeObjects = annotationCanvas.getActiveObjects();
                if(activeObjects.length > 0) {
                    e.preventDefault();
                    activeObjects.forEach(obj => {
                        annotationCanvas.remove(obj);
                    });
                    annotationCanvas.discardActiveObject();
                    annotationCanvas.renderAll();
                }
                return;
            }

            // M 键切换魔棒模式
            if(e.key.toLowerCase() === 'm' && currentTool === 'wand') {
                e.preventDefault();
                toggleWandMode();
                return;
            }

            // 工具快捷键
            if(!e.ctrlKey && !e.altKey && !e.metaKey) {
                switch(e.key.toLowerCase()) {
                    case 'b':
                        setTool('brush');
                        break;
                    case 'l':
                        setTool('lasso');
                        break;
                    case 'w':
                        setTool('wand');
                        break;
                    case 't':
                        setTool('text');
                        break;
                }
            }
        });

        function updateBrushSettings() {
            if(annotationCanvas && annotationCanvas.freeDrawingBrush) {
                annotationCanvas.freeDrawingBrush.color = annotationState.brushColor;
                annotationCanvas.freeDrawingBrush.width = parseInt(annotationState.brushSize);
            }
        }

        // ========== 套索工具（多边形选择）==========
        function setupLassoTool() {
            if(!isCanvasReady) return;

            currentTool = 'lasso';
            annotationCanvas.isDrawingMode = false;
            annotationCanvas.selection = false;

            document.getElementById('annotationStatus').innerText = '工具: 套索（点击绘制多边形，双击完成闭合）';
            annotationState.polygonPoints = [];
            polygonLines = [];

            // 清除旧的临时元素
            if(tempLine) {
                annotationCanvas.remove(tempLine);
                tempLine = null;
            }
        }

        function handleLassoClick(pointer) {
            if(!isCanvasReady || !annotationCanvas) return;

            annotationState.polygonPoints.push(pointer);

            // 添加点标记
            const circle = new fabric.Circle({
                left: pointer.x - 3,
                top: pointer.y - 3,
                radius: 3,
                fill: annotationState.brushColor,
                selectable: false,
                evented: false
            });
            annotationCanvas.add(circle);

            // 如果有之前的点，画线连接
            if(annotationState.polygonPoints.length > 1) {
                const prevPoint = annotationState.polygonPoints[annotationState.polygonPoints.length - 2];
                const line = new fabric.Line([prevPoint.x, prevPoint.y, pointer.x, pointer.y], {
                    stroke: annotationState.brushColor,
                    strokeWidth: 2,
                    selectable: false,
                    evented: false
                });
                annotationCanvas.add(line);
                polygonLines.push(line);
            }

            // 移除临时预览线
            if(tempLine) {
                annotationCanvas.remove(tempLine);
                tempLine = null;
            }

            // 立即渲染
            annotationCanvas.renderAll();
        }

        function updateLassoPreview(pointer) {
            const lastPoint = annotationState.polygonPoints[annotationState.polygonPoints.length - 1];
            if(!lastPoint) return;

            // 移除旧的临时线
            if(tempLine) {
                annotationCanvas.remove(tempLine);
            }

            // 创建新的临时预览线
            tempLine = new fabric.Line([lastPoint.x, lastPoint.y, pointer.x, pointer.y], {
                stroke: annotationState.brushColor,
                strokeWidth: 1,
                strokeDashArray: [5, 5],
                selectable: false,
                evented: false,
                opacity: 0.6
            });
            annotationCanvas.add(tempLine);
            annotationCanvas.renderAll();
        }

        function completePolygon() {
            if(annotationState.polygonPoints.length < 3) return;

            // 移除临时预览线
            if(tempLine) {
                annotationCanvas.remove(tempLine);
                tempLine = null;
            }

            // 移除所有辅助点标记和线条
            polygonLines.forEach(line => annotationCanvas.remove(line));
            const objects = annotationCanvas.getObjects();
            for(let i = objects.length - 1; i >= 0; i--) {
                if(objects[i].type === 'circle') {
                    annotationCanvas.remove(objects[i]);
                }
            }

            // 创建半透明填充的多边形
            const polygonPoints = annotationState.polygonPoints.map(p => ({ x: p.x, y: p.y }));
            const polygon = new fabric.Polygon(polygonPoints, {
                fill: annotationState.brushColor + '40',
                stroke: annotationState.brushColor,
                strokeWidth: 2,
                selectable: false,
                evented: false
            });
            annotationCanvas.add(polygon);

            // 渲染并保存状态
            annotationCanvas.renderAll();
            saveAnnotationState();

            // 重置
            annotationState.polygonPoints = [];
            polygonLines = [];

            document.getElementById('annotationStatus').innerText = '工具: 套索（已完成，可继续绘制）';
        }

        // ========== 魔棒工具（颜色相似度选择）==========
        function setupWandTool() {
            if(!isCanvasReady) return;

            currentTool = 'wand';
            annotationCanvas.isDrawingMode = false;
            updateWandStatus();
        }

        function updateWandStatus() {
            const modeText = annotationState.wandMode === 'add' ? '增加选区' : '减少选区';
            document.getElementById('annotationStatus').innerText = `工具: 魔棒（${modeText} - 点击选择相似颜色区域，按 M 切换）`;

            // 更新UI上的模式按钮
            const modeBtn = document.getElementById('wandModeBtn');
            const modeTextEl = document.getElementById('wandModeText');
            if(modeBtn && modeTextEl) {
                modeTextEl.innerText = annotationState.wandMode === 'add' ? '增加' : '减少';
                if(annotationState.wandMode === 'add') {
                    modeBtn.classList.remove('bg-red-50', 'border-red-300');
                    modeBtn.classList.add('bg-green-50', 'border-green-300');
                } else {
                    modeBtn.classList.remove('bg-green-50', 'border-green-300');
                    modeBtn.classList.add('bg-red-50', 'border-red-300');
                }
            }
        }

        function toggleWandMode() {
            annotationState.wandMode = annotationState.wandMode === 'add' ? 'subtract' : 'add';
            updateWandStatus();
        }

        function performMagicWand(startX, startY) {
            if(!isCanvasReady || !annotationCanvas || !backgroundImageElement) return;

            // 获取原始背景图片元素
            const imgElement = backgroundImageElement.getElement();
            if(!imgElement) return;

            // 获取图片的实际显示尺寸和位置
            const displayWidth = backgroundImageElement.width * backgroundImageElement.scaleX;
            const displayHeight = backgroundImageElement.height * backgroundImageElement.scaleY;
            const offsetX = backgroundImageElement.left;
            const offsetY = backgroundImageElement.top;

            console.log('魔棒点击:', { startX, startY, offsetX, offsetY, displayWidth, displayHeight });

            // 计算点击位置在图片上的相对坐标
            const relX = startX - offsetX;
            const relY = startY - offsetY;

            // 边界检查
            if(relX < 0 || relX >= displayWidth || relY < 0 || relY >= displayHeight) {
                document.getElementById('annotationStatus').innerText = `工具: 魔棒（点击位置超出图片范围: ${Math.floor(relX)}, ${Math.floor(relY)}）`;
                return;
            }

            // 将相对坐标转换为原始图片坐标
            const originalWidth = imgElement.width;
            const originalHeight = imgElement.height;
            const imgX = Math.floor((relX / displayWidth) * originalWidth);
            const imgY = Math.floor((relY / displayHeight) * originalHeight);

            console.log('转换后的图片坐标:', { imgX, imgY, originalWidth, originalHeight });

            // 创建临时 Canvas 来获取原始图片的像素数据
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = originalWidth;
            tempCanvas.height = originalHeight;
            const tempCtx = tempCanvas.getContext('2d');

            // 绘制原始图片
            tempCtx.drawImage(imgElement, 0, 0);

            // 获取像素数据
            const imageData = tempCtx.getImageData(0, 0, originalWidth, originalHeight);
            const pixels = imageData.data;

            // 边界检查（使用原始尺寸）
            if(imgX < 0 || imgX >= originalWidth || imgY < 0 || imgY >= originalHeight) {
                document.getElementById('annotationStatus').innerText = '工具: 魔棒（坐标转换错误）';
                return;
            }

            // 获取起始点颜色
            const startIdx = (imgY * originalWidth + imgX) * 4;
            const startR = pixels[startIdx];
            const startG = pixels[startIdx + 1];
            const startB = pixels[startIdx + 2];
            const startA = pixels[startIdx + 3];

            if(startA === 0) {
                document.getElementById('annotationStatus').innerText = '工具: 魔棒（点击了透明区域）';
                return;
            }

            // 容差转换 (0-100 -> 0-255)
            const tolerance = annotationState.tolerance * 2.55;

            // 泛洪填充算法选择连续区域
            const visited = new Uint8Array(originalWidth * originalHeight);
            const stack = [[imgX, imgY]];
            const selectedPixels = [];

            while(stack.length > 0) {
                const [x, y] = stack.pop();
                const idx = y * originalWidth + x;

                if(visited[idx]) continue;
                visited[idx] = 1;

                const pixelIdx = idx * 4;
                const r = pixels[pixelIdx];
                const g = pixels[pixelIdx + 1];
                const b = pixels[pixelIdx + 2];
                const a = pixels[pixelIdx + 3];

                // 计算颜色差异
                const diff = Math.sqrt(
                    Math.pow(r - startR, 2) +
                    Math.pow(g - startG, 2) +
                    Math.pow(b - startB, 2)
                );

                if(diff <= tolerance && a > 0) {
                    // 将原始图片坐标转换回 Canvas 坐标
                    selectedPixels.push({
                        x: offsetX + (x / originalWidth) * displayWidth,
                        y: offsetY + (y / originalHeight) * displayHeight
                    });

                    // 添加相邻像素
                    if(x > 0) stack.push([x - 1, y]);
                    if(x < originalWidth - 1) stack.push([x + 1, y]);
                    if(y > 0) stack.push([x, y - 1]);
                    if(y < originalHeight - 1) stack.push([x, y + 1]);
                }
            }

            console.log('魔棒选择了', selectedPixels.length, '个像素');

            if(selectedPixels.length === 0) {
                document.getElementById('annotationStatus').innerText = '工具: 魔棒（未找到匹配像素）';
                return;
            }

            // 创建选择区域多边形
            createWandSelection(selectedPixels);
        }

        function createWandSelection(pixels) {
            if(pixels.length < 3) {
                document.getElementById('annotationStatus').innerText = `工具: 魔棒（选中了 ${pixels.length} 个像素，太少）`;
                return;
            }

            // 简化点集
            const simplifiedPoints = simplifyPixelsToPolygon(pixels);

            if(annotationState.wandMode === 'add') {
                // 增加选区模式
                const polygon = new fabric.Polygon(simplifiedPoints, {
                    fill: annotationState.brushColor + '40',
                    stroke: annotationState.brushColor,
                    strokeWidth: 2,
                    selectable: false,
                    evented: false
                });
                annotationCanvas.add(polygon);
            } else {
                // 减少选区模式
                const objects = annotationCanvas.getObjects();
                objects.forEach(obj => {
                    if(obj.type === 'polygon' && obj.fill && obj.fill.includes) {
                        annotationCanvas.remove(obj);
                    }
                });
            }

            annotationCanvas.renderAll();
            saveAnnotationState();

            document.getElementById('annotationStatus').innerText = `工具: 魔棒（选择了 ${pixels.length} 个像素）`;
        }

        // 将像素点简化为多边形
        function simplifyPixelsToPolygon(pixels) {
            if(pixels.length <= 10) return pixels;

            // 找边界点（使用简单的网格聚合）
            const gridSize = 5;
            const grid = {};

            pixels.forEach(p => {
                const gridX = Math.floor(p.x / gridSize);
                const gridY = Math.floor(p.y / gridSize);
                const key = `${gridX},${gridY}`;

                if(!grid[key]) {
                    grid[key] = p;
                }
            });

            const boundaryPoints = Object.values(grid);

            // 使用凸包算法获取边界
            return getConvexHull(boundaryPoints);
        }

        // 计算凸包（Graham 扫描算法）
        function getConvexHull(points) {
            if(points.length <= 3) return points;

            // 找到最底部的点（y最大，如果有多个则取x最小）
            const start = points.reduce((a, b) =>
                a.y > b.y || (a.y === b.y && a.x < b.x) ? a : b
            );

            // 按极角排序
            const sorted = points.filter(p => p !== start).sort((a, b) => {
                const angleA = Math.atan2(a.y - start.y, a.x - start.x);
                const angleB = Math.atan2(b.y - start.y, b.x - start.x);
                return angleA - angleB;
            });

            // Graham 扫描
            const hull = [start];

            function crossProduct(o, a, b) {
                return (a.x - o.x) * (b.y - o.y) - (a.y - o.y) * (b.x - o.x);
            }

            for(const point of sorted) {
                while(hull.length > 1 && crossProduct(hull[hull.length - 2], hull[hull.length - 1], point) <= 0) {
                    hull.pop();
                }
                hull.push(point);
            }

            return hull;
        }

        // 文字工具
        function setupTextTool() {
            if(!isCanvasReady) return;

            currentTool = 'text';
            document.getElementById('annotationStatus').innerText = '工具: 文字（点击画布添加文字）';
        }

        function handleTextClick(pointer) {
            if(!isCanvasReady || !annotationCanvas) return;

            const text = new fabric.IText('点击编辑', {
                left: pointer.x,
                top: pointer.y,
                fontFamily: 'Arial',
                fill: annotationState.brushColor,
                fontSize: parseInt(annotationState.brushSize) + 12
            });
            annotationCanvas.add(text);
            annotationCanvas.setActiveObject(text);
            text.enterEditing();
            text.selectAll();
        }

        // 撤销/恢复
        function undoAnnotation() {
            if(annotationState.undoStack.length <= 1) {
                console.log('没有更多可撤销的操作');
                return;
            }

            console.log('执行撤销，当前栈深度:', annotationState.undoStack.length);

            // 弹出当前状态保存到 redoStack
            const currentState = annotationState.undoStack.pop();
            annotationState.redoStack.push(currentState);

            // 获取上一个状态
            const prevState = annotationState.undoStack[annotationState.undoStack.length - 1];

            // 加载上一个状态
            annotationCanvas.loadFromJSON(prevState, function() {
                // 恢复背景图片
                if(annotationState.currentImageSrc && backgroundImageElement) {
                    annotationCanvas.setBackgroundImage(backgroundImageElement, function() {
                        annotationCanvas.renderAll();
                        console.log('撤销完成，栈深度:', annotationState.undoStack.length);
                    });
                } else {
                    annotationCanvas.renderAll();
                    console.log('撤销完成，栈深度:', annotationState.undoStack.length);
                }
            });
        }

        function redoAnnotation() {
            if(annotationState.redoStack.length === 0) {
                console.log('没有更多可恢复的操作');
                return;
            }

            console.log('执行恢复，当前 redo 栈深度:', annotationState.redoStack.length);

            // 获取要恢复的状态
            const nextState = annotationState.redoStack.pop();
            annotationState.undoStack.push(nextState);

            // 加载状态
            annotationCanvas.loadFromJSON(nextState, function() {
                // 恢复背景图片
                if(annotationState.currentImageSrc && backgroundImageElement) {
                    annotationCanvas.setBackgroundImage(backgroundImageElement, function() {
                        annotationCanvas.renderAll();
                        console.log('恢复完成，redo 栈深度:', annotationState.redoStack.length);
                    });
                } else {
                    annotationCanvas.renderAll();
                    console.log('恢复完成，redo 栈深度:', annotationState.redoStack.length);
                }
            });
        }

        // 清空画布
        function clearAnnotation() {
            if(!annotationCanvas) return;

            // 移除所有对象
            annotationCanvas.clear();
            annotationCanvas.setBackgroundColor('#fff');

            // 重新加载背景图
            if(annotationState.currentImageSrc) {
                // 暂时设置为未就绪，等待图片加载完成
                isCanvasReady = false;
                document.getElementById('annotationStatus').innerText = '正在重新加载图片...';

                fabric.Image.fromURL(annotationState.currentImageSrc, function(img) {
                    const scale = Math.min(
                        800 / img.width,
                        600 / img.height
                    );
                    img.set({
                        scaleX: scale,
                        scaleY: scale,
                        selectable: false,
                        evented: false
                    });
                    annotationCanvas.setBackgroundImage(img, function() {
                        annotationCanvas.renderAll();
                        isCanvasReady = true;
                        document.getElementById('annotationStatus').innerText = '工具: 画笔 - 就绪';
                        setupBrushTool();
                    });
                    document.getElementById('canvasPlaceholder').style.display = 'none';
                });
            } else {
                document.getElementById('canvasPlaceholder').style.display = 'block';
            }

            // 重置工具状态
            annotationState.polygonPoints = [];
            polygonLines = [];
            if(tempLine) {
                tempLine = null;
            }
        }

        // 导出标注图
        function exportAnnotatedImage() {
            if(!annotationState.currentImageSrc || !annotationState.imageLoaded || !isCanvasReady) {
                alert('请先选择要标注的图片，并等待图片加载完成');
                return;
            }

            console.log('开始导出标注图...');

            // 隐藏选中框
            annotationCanvas.discardActiveObject();
            annotationCanvas.renderAll();

            // 获取原始图片元素和尺寸
            const imgElement = backgroundImageElement.getElement();
            const originalWidth = imgElement.width;
            const originalHeight = imgElement.height;

            console.log('原图尺寸:', originalWidth, 'x', originalHeight);
            console.log('Canvas上的对象数量:', annotationCanvas.getObjects().length);

            // 创建一个临时的 Fabric Canvas，使用原始图片尺寸
            const exportCanvas = new fabric.Canvas(null, {
                width: originalWidth,
                height: originalHeight
            });

            // 添加背景图片
            fabric.Image.fromObject(backgroundImageElement, function(bgImg) {
                bgImg.set({
                    scaleX: 1,
                    scaleY: 1,
                    left: 0,
                    top: 0
                });
                exportCanvas.setBackgroundImage(bgImg, function() {
                    // 获取当前 Canvas 的缩放比例和偏移
                    const scale = backgroundImageElement.scaleX;
                    const offsetX = backgroundImageElement.left;
                    const offsetY = backgroundImageElement.top;

                    console.log('缩放比例:', scale, '偏移:', offsetX, offsetY);

                    // 复制所有标注对象并调整坐标
                    const objects = annotationCanvas.getObjects();
                    objects.forEach(obj => {
                        // 克隆对象
                        obj.clone(function(clonedObj) {
                            // 计算在原图上的位置和缩放
                            const originalX = (obj.left - offsetX) / scale;
                            const originalY = (obj.top - offsetY) / scale;
                            const originalScaleX = obj.scaleX / scale;
                            const originalScaleY = obj.scaleY / scale;

                            clonedObj.set({
                                left: originalX,
                                top: originalY,
                                scaleX: originalScaleX,
                                scaleY: originalScaleY
                            });

                            exportCanvas.add(clonedObj);
                        });
                    });

                    // 渲染并导出
                    exportCanvas.renderAll();
                    const dataURL = exportCanvas.toDataURL({
                        format: 'png',
                        quality: 1
                    });

                    console.log('导出完成，数据长度:', dataURL.length);

                    // 保存到平台状态
                    platformState.currentAnnotatedImage = dataURL;

                    // 将标注后的图片添加到参考图列表
                    const id = 'annotated-' + Date.now();
                    const tray = document.getElementById('imageTray');
                    tray.classList.remove('hidden');

                    const div = document.createElement('div');
                    div.id = `up-${id}`;
                    div.className = "relative group w-14 h-14 rounded-xl overflow-hidden border-2 border-green-200 shrink-0 shadow-sm transition-all hover:scale-105 cursor-pointer";
                    div.innerHTML = `
                        <img src="${dataURL}" class="w-full h-full object-cover" data-annotation-img="${id}">
                        <div class="absolute bottom-0 left-0 right-0 bg-green-500/80 text-white text-[7px] text-center py-0.5">已标注</div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex flex items-center justify-center gap-1">
                            <button class="preview-btn text-white text-[8px] bg-blue-500/80 rounded px-1.5 py-0.5 hover:bg-blue-500 transition" title="预览" data-img-id="${id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="annotate-btn text-white text-[8px] bg-black/50 rounded px-1.5 py-0.5 hover:bg-black/80 transition" title="继续标注" data-img-id="${id}">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button class="delete-btn text-white text-[8px] bg-red-500/80 rounded px-1.5 py-0.5 hover:bg-red-500 transition" title="删除" data-img-id="${id}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    tray.appendChild(div);

                    // 同时添加到 currentRefImgs（带标注标记）
                    platformState.currentRefImgs.push({id, b64: dataURL, isAnnotated: true});

                    // 绑定事件
                    const img = div.querySelector('img');
                    img.addEventListener('click', () => openModal(dataURL, '标注图预览', '', [dataURL]));

                    const previewBtn = div.querySelector('.preview-btn');
                    previewBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openModal(dataURL, '标注图预览', '', [dataURL]);
                    });

                    const annotateBtn = div.querySelector('.annotate-btn');
                    annotateBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openAnnotationModal(dataURL);
                    });

                    const deleteBtn = div.querySelector('.delete-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        div.remove();
                        platformState.currentRefImgs = platformState.currentRefImgs.filter(i => i.id !== id);
                        if(platformState.currentRefImgs.length === 0) tray.classList.add('hidden');
                    });

                    // 清理临时 Canvas
                    exportCanvas.dispose();

                    // 更新 UI 显示
                    closeAnnotationModal();
                    document.getElementById('annotationStatus').innerText = '标注图已添加到参考图列表';
                });
            });
        }

        // 画笔颜色/大小/容差变化
        document.addEventListener('DOMContentLoaded', function() {
            const colorInput = document.getElementById('brushColor');
            const sizeInput = document.getElementById('brushSize');
            const sizeValue = document.getElementById('brushSizeValue');
            const toleranceInput = document.getElementById('toleranceSlider');
            const toleranceValue = document.getElementById('toleranceValue');

            if(colorInput) {
                colorInput.addEventListener('input', function() {
                    annotationState.brushColor = this.value;
                    updateBrushSettings();
                });
            }

            if(sizeInput) {
                sizeInput.addEventListener('input', function() {
                    annotationState.brushSize = this.value;
                    if(sizeValue) sizeValue.innerText = this.value;
                    updateBrushSettings();
                });
            }

            if(toleranceInput) {
                toleranceInput.addEventListener('input', function() {
                    annotationState.tolerance = parseInt(this.value);
                    if(toleranceValue) toleranceValue.innerText = this.value;
                });
            }
        });

        function handleLogout() { location.reload(); }
        document.addEventListener('mousemove', e => { document.querySelectorAll('.spotlight-btn').forEach(btn => { const rect = btn.getBoundingClientRect(); btn.style.setProperty('--x', `${e.clientX - rect.left}px`); btn.style.setProperty('--y', `${e.clientY - rect.top}px`); }); });
        document.addEventListener('paste', e => { const items = (e.clipboardData || e.originalEvent.clipboardData).items; for (let item of items) { if (item.kind === 'file') captureAssets([item.getAsFile()]); } });
    </script>
</body>
</html>